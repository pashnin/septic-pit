
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ¡Ğ»Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞ¼Ğ°</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:#f0f4f8; --surface:#fff; --surface2:#f8fafc;
  --border:#e2e8f0; --text:#1e293b; --text2:#64748b;
  --accent:#3b82f6; --shadow:0 2px 12px rgba(0,0,0,.08);
}
body.dark {
  --bg:#0f172a; --surface:#1e293b; --surface2:#273449;
  --border:#334155; --text:#f1f5f9; --text2:#94a3b8;
  --shadow:0 2px 16px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;transition:background .3s,color .3s;min-height:100vh}

header{background:var(--surface);border-bottom:1px solid var(--border);padding:13px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.h-left{display:flex;align-items:center;gap:9px;font-size:17px;font-weight:700}
.h-right{display:flex;align-items:center;gap:8px}
#dataAge{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);padding:4px 10px;border-radius:20px}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 13px;border-radius:20px;cursor:pointer;font-size:13px;transition:.2s}
.btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

main{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
.sec{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin:22px 0 10px;display:flex;align-items:center;gap:10px}
.sec-time{font-size:12px;font-weight:700;color:var(--text);background:var(--surface);border:1px solid var(--border);padding:2px 10px;border-radius:20px;text-transform:none;letter-spacing:0}

.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow);transition:background .3s}
.lbl{font-size:11px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.val{font-size:30px;font-weight:800;line-height:1}
.sub{font-size:12px;color:var(--text2);margin-top:5px}

/* Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ */
.lv-gauge-wrap{position:relative;width:100px;height:100px;margin:8px auto}
.lv-gauge-wrap canvas{position:absolute;top:0;left:0}
.lv-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.lv-num{font-size:19px;font-weight:800;line-height:1}
.lv-unit{font-size:10px;color:var(--text2);margin-top:2px}
.badge{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600;padding:3px 10px;border-radius:20px;margin:8px 0 6px}
.sg{background:#dcfce7;color:#15803d} body.dark .sg{background:#14532d;color:#86efac}
.sy{background:#fef9c3;color:#a16207} body.dark .sy{background:#451a03;color:#fcd34d}
.sr{background:#fee2e2;color:#b91c1c} body.dark .sr{background:#450a0a;color:#fca5a5}
.fc-mini{font-size:11px;color:var(--text2);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;margin-top:6px}
.fc-mini b{color:var(--text)}
.avg-mini{font-size:11px;color:var(--text2);margin-bottom:4px}
.avg-mini b{color:var(--text)}

/* Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ */
.bat-wrap{position:relative;width:90px;height:55px;margin:8px auto 4px}
.bat-num{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:13px;font-weight:700;white-space:nowrap}

/* ĞĞ»ĞµÑ€Ñ‚ Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ */
.hum-alert{display:none;background:#fee2e2;color:#b91c1c;border-radius:10px;padding:6px 10px;font-size:12px;font-weight:600;margin-top:8px;text-align:center;line-height:1.4}
body.dark .hum-alert{background:#450a0a;color:#fca5a5}
.hum-alert.show{display:block}

/* Ğ“Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸ */
.chart-card{padding:18px}
.chart-wrap{position:relative;height:200px}
.chart-title{font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text)}

#errBox{display:none;background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;border-radius:12px;padding:14px 18px;margin:20px 0;font-size:14px;line-height:1.6}
#loader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:14px}
.spin{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader p{color:var(--text2);font-size:14px}

@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}
@media(max-width:560px){.g2{grid-template-columns:1fr}.chart-wrap{height:160px}}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…â€¦</p></div>
<div id="errBox"></div>

<header>
  <div class="h-left">ğŸ  Ğ¡Ğ»Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞ¼Ğ°</div>
  <div class="h-right">
    <span id="dataAge">â€”</span>
    <button class="btn" onclick="toggleTheme()">ğŸŒ™ Ğ¢ĞµĞ¼Ğ°</button>
  </div>
</header>

<main id="app" style="display:none">

  <div class="sec">
    ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    <span class="sec-time" id="secTime">â€”</span>
  </div>

  <div class="g4">
    <!-- Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹ -->
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸ“ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹</div>
      <div class="lv-gauge-wrap">
        <canvas id="lvGauge" width="100" height="100"></canvas>
        <div class="lv-center">
          <div class="lv-num" id="lvNum">â€”</div>
          <div class="lv-unit">Ğ¼ĞµÑ‚Ñ€Ñ‹</div>
        </div>
      </div>
      <div class="badge" id="lvBadge">â€”</div>
      <div class="avg-mini">Ğ¡Ñ€. Ñ‡Ğ°Ñ (7Ğ´): <b id="avgHour">â€”</b></div>
      <div class="fc-mini">
        â†‘ Ğ´Ğ¾ âˆ’0.50 Ğ¼: <b id="fc50">â€”</b><br>
        â†“ Ğ´Ğ¾ âˆ’0.65 Ğ¼: <b id="fc65">â€”</b>
      </div>
    </div>

    <!-- Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ -->
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸ”‹ Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ</div>
      <div class="bat-wrap">
        <canvas id="batGauge" width="90" height="55"></canvas>
        <div class="bat-num" id="batNum">â€”</div>
      </div>
      <div class="sub" id="batSub">â€”</div>
    </div>

    <!-- Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° -->
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°</div>
      <div class="val" id="tempVal" style="margin-top:32px">â€”</div>
      <div class="sub">Â°C Ğ² ÑĞ¼Ğµ</div>
    </div>

    <!-- Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ -->
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</div>
      <div class="val" id="humVal" style="margin-top:32px">â€”</div>
      <div class="sub">% RH</div>
      <div class="hum-alert" id="humAlert">â€”</div>
    </div>
  </div>

  <!-- Ğ Ğ¯Ğ” 2 -->
  <div class="sec">ğŸ“‰ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹</div>
  <div class="g2">
    <div class="card chart-card">
      <div class="chart-title">Ğ—Ğ° 24 Ñ‡Ğ°ÑĞ°</div>
      <div class="chart-wrap"><canvas id="c24"></canvas></div>
    </div>
    <div class="card chart-card">
      <div class="chart-title">Ğ—Ğ° 7 Ğ´Ğ½ĞµĞ¹</div>
      <div class="chart-wrap"><canvas id="c7d"></canvas></div>
    </div>
  </div>

  <!-- Ğ Ğ¯Ğ” 3 -->
  <div class="sec">ğŸ“† Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ</div>
  <div class="g2">
    <div class="card chart-card">
      <div class="chart-title">ĞŸĞ¾ Ñ‡Ğ°ÑĞ°Ğ¼ ÑÑƒÑ‚Ğ¾Ğº â€” ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° 7 Ğ´Ğ½ĞµĞ¹</div>
      <div class="chart-wrap"><canvas id="cByHour"></canvas></div>
    </div>
    <div class="card chart-card">
      <div class="chart-title">ĞŸĞ¾ Ğ´Ğ½ÑĞ¼ â€” ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° 30 Ğ´Ğ½ĞµĞ¹</div>
      <div class="chart-wrap"><canvas id="cByDay"></canvas></div>
    </div>
  </div>

  <!-- Ğ Ğ¯Ğ” 4 -->
  <div class="sec">ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¸ Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ° 24 Ñ‡Ğ°ÑĞ°</div>
  <div class="g2">
    <div class="card chart-card">
      <div class="chart-title">Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° (Â°C)</div>
      <div class="chart-wrap"><canvas id="cTemp"></canvas></div>
    </div>
    <div class="card chart-card">
      <div class="chart-title">Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ (%)</div>
      <div class="chart-wrap"><canvas id="cHum"></canvas></div>
    </div>
  </div>

</main>

<script>
// â”€â”€ Ğ¢Ğ•ĞœĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const d = document.body.classList.toggle('dark');
  localStorage.setItem('theme', d ? 'dark' : 'light');
  document.querySelector('.btn').textContent = d ? 'â˜€ï¸ Ğ¢ĞµĞ¼Ğ°' : 'ğŸŒ™ Ğ¢ĞµĞ¼Ğ°';
}
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  document.querySelector('.btn').textContent = 'â˜€ï¸ Ğ¢ĞµĞ¼Ğ°';
}

// â”€â”€ CSV ĞŸĞĞ Ğ¡Ğ•Ğ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseLine(line) {
  const fields = []; let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { fields.push(cur.trim()); cur = ''; }
    else { cur += c; }
  }
  fields.push(cur.trim());
  return fields;
}

function toNum(s) {
  return parseFloat((s || '').replace(/"/g, '').replace(',', '.'));
}

function parseCSV(text) {
  const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n')
                    .split('\n').map(l=>l.trim()).filter(Boolean);
  if (lines.length < 2) return [];
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const p = parseLine(lines[i]);
    if (p.length < 6) continue;
    const dp = p[0].split('.');
    if (dp.length < 3) continue;
    const yr = parseInt(dp[2],10) < 100 ? 2000+parseInt(dp[2],10) : parseInt(dp[2],10);
    const tp = p[1].split(':');
    const dt = new Date(yr, parseInt(dp[1],10)-1, parseInt(dp[0],10),
                        parseInt(tp[0],10), parseInt(tp[1]||'0',10));
    if (isNaN(dt.getTime())) continue;
    const dist = toNum(p[2]);
    const temp = toNum(p[3]);
    const hum  = toNum(p[4]);
    const bat  = toNum(p[5]);
    if ([dist,temp,hum,bat].some(isNaN)) continue;
    rows.push({ dt, dist, temp, hum, bat });
  }
  rows.sort((a,b) => a.dt - b.dt);
  return rows;
}

// â”€â”€ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// dist Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹: -1.000 = Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ Ğ´Ğ°Ñ‚Ñ‡Ğ¸ĞºĞ° (Ñ€Ğ¾Ğ²Ğ½Ğ¾ -1)
// Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½: Ğ¾Ñ‚ -0.3 Ğ´Ğ¾ -0.95 (Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ)
function okDist(d) {
  return d < -0.2 && d > -0.95 && Math.abs(d - (-1.0)) > 0.01;
}

function levelStatus(d) {
  if (d > -0.5)   return { color:'#ef4444', cls:'sr', label:'ğŸ”´ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹' };
  if (d >= -0.65) return { color:'#f59e0b', cls:'sy', label:'ğŸŸ¡ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹' };
  return                 { color:'#22c55e', cls:'sg', label:'ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹'  };
}

// Gauge: Ğ±Ğ»Ğ¸Ğ¶Ğµ Ğº 0 â€” Ğ¿Ğ»Ğ¾Ñ…Ğ¾ (Ğ¼Ğ°Ğ»Ğ¾ Ğ¼ĞµÑÑ‚Ğ°), Ğ´Ğ°Ğ»ÑŒÑˆĞµ â€” Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾
// Ğ”Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ: 0 .. -0.80
function lvPct(d) { return Math.max(0, Math.min(1, Math.abs(d) / 0.80)); }

// â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCircle(id, pct, color) {
  const dark = document.body.classList.contains('dark');
  const bg = dark ? '#334155' : '#e2e8f0';
  const cv = document.getElementById(id);
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  const cx=cv.width/2, cy=cv.height/2, r=Math.min(cx,cy)-8;
  ctx.lineWidth=10; ctx.lineCap='round';
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle=bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+pct*Math.PI*2);
  ctx.strokeStyle=color; ctx.stroke();
}

function drawBat(pct, color) {
  const dark = document.body.classList.contains('dark');
  const bg = dark ? '#334155' : '#e2e8f0';
  const cv = document.getElementById('batGauge');
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  const cx=cv.width/2, cy=cv.height-4, r=cx-6;
  ctx.lineWidth=9; ctx.lineCap='round';
  ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,0); ctx.strokeStyle=bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,Math.PI+pct*Math.PI);
  ctx.strokeStyle=color; ctx.stroke();
}

// â”€â”€ Ğ“Ğ ĞĞ¤Ğ˜ĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CH = {};

function gc() { return document.body.classList.contains('dark') ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.05)'; }
function tc() { return document.body.classList.contains('dark') ? '#94a3b8' : '#64748b'; }

// Ğ˜Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑˆĞºĞ°Ğ»Ğ° Ğ´Ğ»Ñ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ²Ğ¾Ğ´Ñ‹
// reverse:true â€” Ğ² Chart.js ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑÑ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Ğ¾Ğ±ÑŠĞµĞºÑ‚ scale
function yInv() {
  return { reverse:true, ticks:{color:tc()}, grid:{color:gc()} };
}
function yNorm() {
  return { ticks:{color:tc()}, grid:{color:gc()} };
}
function xScale() {
  return { ticks:{color:tc(), maxTicksLimit:8, maxRotation:0}, grid:{color:gc()} };
}

function mkLine(id, labels, data, color, fillColor, invertY) {
  if (CH[id]) CH[id].destroy();
  CH[id] = new Chart(document.getElementById(id), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data,
        borderColor: color,
        backgroundColor: fillColor,
        fill: true,
        tension: .35,
        pointRadius: data.length > 100 ? 0 : 2,
        pointHoverRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: { legend:{ display:false } },
      scales: {
        x: xScale(),
        y: invertY ? yInv() : yNorm()
      }
    }
  });
}

function mkBar(id, labels, data, barColors) {
  if (CH[id]) CH[id].destroy();
  CH[id] = new Chart(document.getElementById(id), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: barColors,
        borderRadius: 4,
        barPercentage: .75
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: { legend:{ display:false } },
      scales: {
        x: xScale(),
        y: yInv()
      }
    }
  });
}

// â”€â”€ ĞŸĞ ĞĞ“ĞĞĞ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildForecast(rows, lv, lvDt) {
  const valid = rows.filter(r => okDist(r.dist));
  const deltas = Array.from({length:24}, ()=>[]);
  for (let i = 1; i < valid.length; i++) {
    const a=valid[i-1], b=valid[i];
    const ms = b.dt - a.dt;
    if (ms <= 0 || ms > 2*3600000) continue;
    deltas[b.dt.getHours()].push((b.dist - a.dist) / (ms/3600000));
  }
  const avg = deltas.map(arr => arr.length ? arr.reduce((s,x)=>s+x,0)/arr.length : 0);

  function reach(target, goUp) {
    let v = lv, dt = new Date(lvDt);
    for (let h = 0; h < 7*24; h++) {
      v += avg[dt.getHours()];
      dt = new Date(dt.getTime() + 3600000);
      if (goUp ? v >= target : v <= target)
        return dt.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    return 'Ğ½Ğµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ (7Ğ´)';
  }
  return {
    high: reach(-0.50, true),
    low:  reach(-0.65, false)
  };
}

// â”€â”€ Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtAge(ms) {
  const m = Math.round(ms/60000);
  return m < 60 ? `Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ${m} Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´` : `Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ${Math.round(m/60)} Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´`;
}
function fmtTime(dt) {
  return String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
}
function fmtDay(dt) {
  return String(dt.getDate()).padStart(2,'0')+'.'+String(dt.getMonth()+1).padStart(2,'0');
}
function zoneColor(v) {
  if (v > -0.5)   return 'rgba(239,68,68,.75)';
  if (v >= -0.65) return 'rgba(245,158,11,.75)';
  return                 'rgba(34,197,94,.75)';
}
function showError(msg) {
  document.getElementById('loader').style.display='none';
  const b=document.getElementById('errBox');
  b.style.display='block';
  b.innerHTML='âš ï¸ '+msg;
}

// â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const res = await fetch('./data.csv?t='+Date.now());
    if (!res.ok) throw new Error(`data.csv Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ (HTTP ${res.status})`);
    const text = await res.text();
    if (!text.trim()) throw new Error('data.csv Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹');

    const rows = parseCSV(text);
    if (!rows.length) throw new Error(
      'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ data.csv.<br>' +
      'ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: <code>07.02.26,14:59,"-0,676","0,8",13,"4,1"</code>'
    );

    document.getElementById('loader').style.display='none';
    document.getElementById('app').style.display='block';

    const now  = new Date();
    const last = rows[rows.length-1];

    // Ğ’Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
    document.getElementById('dataAge').textContent = fmtAge(now - last.dt);
    document.getElementById('secTime').textContent =
      last.dt.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});

    // Ğ¢ĞµĞ¼Ğ¿ / Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ
    document.getElementById('tempVal').textContent = last.temp.toFixed(1)+' Â°C';
    document.getElementById('humVal').textContent  = last.hum.toFixed(1)+' %';

    // ĞĞ»ĞµÑ€Ñ‚ Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸
    const humAlert = document.getElementById('humAlert');
    const lastN = rows.slice(-10);
    const humRising = lastN.length === 10 &&
      lastN.every((r,i) => i===0 || r.hum >= lastN[i-1].hum);
    const humHigh = last.hum >= 40;
    if (humRising || humHigh) {
      humAlert.classList.add('show');
      humAlert.textContent = humHigh
        ? `âš ï¸ ${last.hum.toFixed(1)}% â€” Ğ²Ñ‹ÑˆĞµ 40%!`
        : 'âš ï¸ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ 10 Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´!';
    } else {
      humAlert.classList.remove('show');
    }

    // Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ â€” Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹
    let lv=null, lvRow=null;
    for (let i=rows.length-1; i>=0; i--) {
      if (okDist(rows[i].dist)) { lv=rows[i].dist; lvRow=rows[i]; break; }
    }

    if (lv !== null) {
      document.getElementById('lvNum').textContent = lv.toFixed(3);
      const st = levelStatus(lv);
      const badge = document.getElementById('lvBadge');
      badge.textContent = st.label;
      badge.className   = 'badge '+st.cls;
      drawCircle('lvGauge', lvPct(lv), st.color);

      // Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ² ÑÑ‚Ğ¾Ñ‚ Ñ‡Ğ°Ñ Ğ·Ğ° 7Ğ´
      const ago7  = new Date(now - 7*86400000);
      const same  = rows.filter(r => r.dt>ago7 && r.dt.getHours()===now.getHours() && okDist(r.dist));
      document.getElementById('avgHour').textContent = same.length
        ? (same.reduce((s,r)=>s+r.dist,0)/same.length).toFixed(3)+' Ğ¼'
        : 'Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';

      // ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·
      const fc = buildForecast(rows, lv, lvRow.dt);
      document.getElementById('fc50').textContent = lv >= -0.50 ? 'âœ… ÑƒĞ¶Ğµ' : fc.high;
      document.getElementById('fc65').textContent = lv <= -0.65 ? 'âœ… ÑƒĞ¶Ğµ' : fc.low;
    } else {
      document.getElementById('lvNum').textContent = 'â€”';
      document.getElementById('lvBadge').textContent = 'âš ï¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
    }

    // Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ
    const bat  = last.bat;
    const pctB = Math.max(0, Math.min(1, (bat-3.1)/1.0));
    const batC = pctB>0.6?'#22c55e':pctB>0.3?'#f59e0b':'#ef4444';
    drawBat(pctB, batC);
    document.getElementById('batNum').textContent = bat.toFixed(2)+' Ğ’';
    document.getElementById('batSub').textContent = Math.round(pctB*100)+'% Ğ·Ğ°Ñ€ÑĞ´Ğ°';

    // â”€â”€ Ğ Ğ¯Ğ” 2: Ğ»Ğ¸Ğ½ĞµĞ¹Ğ½Ñ‹Ğµ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ms24 = now - 24*3600000;
    const ms7  = now - 7*86400000;

    const r24 = rows.filter(r => r.dt>ms24 && okDist(r.dist));
    mkLine('c24',
      r24.map(r=>fmtTime(r.dt)),
      r24.map(r=>r.dist),
      '#3b82f6', 'rgba(59,130,246,.1)', true
    );

    const r7 = rows.filter(r => r.dt>ms7 && okDist(r.dist));
    mkLine('c7d',
      r7.map(r => {
        const d=r.dt;
        return fmtDay(d)+' '+fmtTime(d);
      }),
      r7.map(r=>r.dist),
      '#10b981', 'rgba(16,185,129,.1)', true
    );

    // â”€â”€ Ğ Ğ¯Ğ” 3Ğ°: ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ¿Ğ¾ Ñ‡Ğ°ÑĞ°Ğ¼ (7Ğ´) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const hourBuckets = Array.from({length:24}, (_,h)=>{
      const pts = rows.filter(r => r.dt>ms7 && r.dt.getHours()===h && okDist(r.dist));
      return pts.length ? pts.reduce((s,r)=>s+r.dist,0)/pts.length : null;
    });
    const hourLabels = Array.from({length:24}, (_,h)=>String(h).padStart(2,'0')+':00');
    const hourColors = hourBuckets.map(v => v===null ? 'transparent' : zoneColor(v));
    mkBar('cByHour', hourLabels, hourBuckets, hourColors);

    // â”€â”€ Ğ Ğ¯Ğ” 3Ğ±: ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ¿Ğ¾ Ğ´Ğ½ÑĞ¼ (30Ğ´) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ms30  = now - 30*86400000;
    const dayMap = {};
    rows.filter(r => r.dt>ms30 && okDist(r.dist)).forEach(r=>{
      const k = fmtDay(r.dt);
      (dayMap[k] = dayMap[k]||[]).push(r.dist);
    });
    const dayLabels = Object.keys(dayMap);
    const dayVals   = dayLabels.map(k =>
      +(dayMap[k].reduce((s,x)=>s+x,0)/dayMap[k].length).toFixed(4)
    );
    const dayColors = dayVals.map(v => zoneColor(v));
    mkBar('cByDay', dayLabels, dayVals, dayColors);

    // â”€â”€ Ğ Ğ¯Ğ” 4: Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¸ Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const rTH = rows.filter(r => r.dt>ms24);
    const lTH = rTH.map(r=>fmtTime(r.dt));

    mkLine('cTemp', lTH, rTH.map(r=>r.temp), '#f97316', 'rgba(249,115,22,.1)', false);
    mkLine('cHum',  lTH, rTH.map(r=>r.hum),  '#06b6d4', 'rgba(6,182,212,.1)',  false);

  } catch(e) {
    showError(e.message);
    console.error(e);
  }
}

loadData();
setInterval(loadData, 5*60*1000);
</script>
</body>
</html>
