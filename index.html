
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ª–∏–≤–Ω–∞—è —è–º–∞ ‚Äî –º–æ–Ω–∏—Ç–æ—Ä</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #f0f4f8;
    --surface: #ffffff;
    --surface2: #f8fafc;
    --border: #e2e8f0;
    --text: #1e293b;
    --text2: #64748b;
    --accent: #3b82f6;
    --green: #22c55e;
    --yellow: #f59e0b;
    --red: #ef4444;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  body.dark {
    --bg: #0f172a;
    --surface: #1e293b;
    --surface2: #273449;
    --border: #334155;
    --text: #f1f5f9;
    --text2: #94a3b8;
    --shadow: 0 2px 12px rgba(0,0,0,0.4);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    transition: background 0.3s, color 0.3s;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    box-shadow: var(--shadow);
  }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-icon { font-size: 22px; }
  .header-title { font-size: 17px; font-weight: 700; letter-spacing: -0.3px; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  #dataAge {
    font-size: 12px;
    color: var(--text2);
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 4px 10px;
    border-radius: 20px;
  }
  .theme-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }
  .theme-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  main { max-width: 900px; margin: 0 auto; padding: 20px 16px; }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text2);
    margin: 24px 0 12px;
  }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }

  /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
    box-shadow: var(--shadow);
    transition: background 0.3s, border-color 0.3s;
  }
  .card-label {
    font-size: 12px;
    color: var(--text2);
    font-weight: 500;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .card-value {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
  }
  .card-sub {
    font-size: 12px;
    color: var(--text2);
    margin-top: 6px;
  }

  /* ‚îÄ‚îÄ LEVEL BIG CARD ‚îÄ‚îÄ */
  .level-card {
    grid-column: span 2;
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 22px 24px;
  }
  .level-visual {
    position: relative;
    width: 110px;
    height: 110px;
    flex-shrink: 0;
  }
  .level-visual canvas { position: absolute; top: 0; left: 0; }
  .level-center {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .level-num { font-size: 22px; font-weight: 800; line-height: 1; }
  .level-unit { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .level-info { flex: 1; }
  .level-info h2 { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .level-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    margin-bottom: 10px;
  }
  .status-green { background: #dcfce7; color: #15803d; }
  .status-yellow { background: #fef9c3; color: #a16207; }
  .status-red { background: #fee2e2; color: #b91c1c; }
  body.dark .status-green { background: #14532d; color: #86efac; }
  body.dark .status-yellow { background: #451a03; color: #fcd34d; }
  body.dark .status-red { background: #450a0a; color: #fca5a5; }
  .avg-row {
    font-size: 13px;
    color: var(--text2);
  }
  .avg-row span { font-weight: 600; color: var(--text); }

  /* ‚îÄ‚îÄ BATTERY GAUGE ‚îÄ‚îÄ */
  .bat-card { text-align: center; }
  .bat-gauge-wrap {
    position: relative;
    width: 90px;
    height: 55px;
    margin: 8px auto 0;
  }
  .bat-gauge-wrap canvas { display: block; }
  .bat-center {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    font-weight: 700;
    text-align: center;
  }

  /* ‚îÄ‚îÄ FORECAST ‚îÄ‚îÄ */
  .forecast-card { border-left: 3px solid var(--accent); }
  .forecast-target { font-size: 11px; color: var(--text2); margin-bottom: 4px; }
  .forecast-val { font-size: 15px; font-weight: 700; }
  .forecast-method {
    font-size: 11px;
    color: var(--text2);
    background: var(--surface2);
    border-radius: 8px;
    padding: 8px 10px;
    margin-top: 12px;
    border: 1px solid var(--border);
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
  .chart-card { padding: 20px; }
  .chart-wrap { position: relative; height: 200px; }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    .grid-4 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr; }
    .grid-2 { grid-template-columns: 1fr; }
    .level-card { grid-column: span 1; flex-direction: column; text-align: center; }
    .level-info h2 { display: none; }
    .chart-wrap { height: 160px; }
    .card-value { font-size: 22px; }
  }

  /* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
  #loader {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 999;
    flex-direction: column; gap: 16px;
  }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loader p { color: var(--text2); font-size: 14px; }
</style>
</head>
<body>

<div id="loader">
  <div class="spinner"></div>
  <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</p>
</div>

<header>
  <div class="header-left">
    <span class="header-icon">üè†</span>
    <span class="header-title">–°–ª–∏–≤–Ω–∞—è —è–º–∞</span>
  </div>
  <div class="header-right">
    <span id="dataAge">‚Äî</span>
    <button class="theme-btn" onclick="toggleTheme()">üåô –¢–µ–º–∞</button>
  </div>
</header>

<main id="mainContent" style="display:none">

  <!-- ROW 1: –£—Ä–æ–≤–µ–Ω—å + –ë–∞—Ç–∞—Ä–µ—è -->
  <div class="section-title">üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
  <div class="grid-2">

    <div class="card level-card">
      <div class="level-visual">
        <canvas id="levelGauge" width="110" height="110"></canvas>
        <div class="level-center">
          <div class="level-num" id="levelNum">‚Äî</div>
          <div class="level-unit">–º–µ—Ç—Ä—ã</div>
        </div>
      </div>
      <div class="level-info">
        <h2>–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã</h2>
        <div class="level-status" id="levelStatus">‚Äî</div>
        <div class="avg-row">
          –°—Ä–µ–¥–Ω–µ–µ –≤ —ç—Ç–æ—Ç —á–∞—Å (7–¥): <span id="avgSameHour">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="card bat-card">
      <div class="card-label">üîã –ë–∞—Ç–∞—Ä–µ—è</div>
      <div class="bat-gauge-wrap">
        <canvas id="batGauge" width="90" height="55"></canvas>
        <div class="bat-center" id="batVal">‚Äî</div>
      </div>
      <div class="card-sub" id="batStatus">‚Äî</div>
    </div>

  </div>

  <!-- ROW 2: –¢–µ–º–ø / –í–ª–∞–∂–Ω–æ—Å—Ç—å / –ü—Ä–æ–≥–Ω–æ–∑—ã -->
  <div class="grid-4" style="margin-top:14px">

    <div class="card">
      <div class="card-label">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
      <div class="card-value" id="tempNow">‚Äî</div>
      <div class="card-sub">¬∞C –≤ —è–º–µ</div>
    </div>

    <div class="card">
      <div class="card-label">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
      <div class="card-value" id="humNow">‚Äî</div>
      <div class="card-sub">% RH</div>
    </div>

    <div class="card forecast-card">
      <div class="card-label">üìà –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí 0.65 –º</div>
      <div class="forecast-target">–î–æ—Å—Ç–∏–≥–Ω–µ—Ç –ø–æ—Ä–æ–≥–∞ ¬´–≤—ã—Å–æ–∫–∏–π¬ª</div>
      <div class="forecast-val" id="forecastHigh">‚Äî</div>
    </div>

    <div class="card forecast-card">
      <div class="card-label">üìâ –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí 0.50 –º</div>
      <div class="forecast-target">–î–æ—Å—Ç–∏–≥–Ω–µ—Ç –ø–æ—Ä–æ–≥–∞ ¬´–Ω–∏–∑–∫–∏–π¬ª</div>
      <div class="forecast-val" id="forecastLow">‚Äî</div>
    </div>

  </div>

  <div class="forecast-method">
    <strong>–ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞:</strong> —Å—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –∑–∞ 7 –¥–Ω–µ–π ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞ —Å—É—Ç–æ–∫ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è Œî (–º/—á–∞—Å).
    –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —ç–∫—Å—Ç—Ä–∞–ø–æ–ª–∏—Ä—É–µ—Ç—Å—è –≤–ø–µ—Ä—ë–¥ –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é. –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π —Ä–∏—Ç–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —è–º—ã.
  </div>

  <!-- CHARTS -->
  <div class="section-title">üìâ –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã ‚Äî 24 —á–∞—Å–∞</div>
  <div class="card chart-card">
    <div class="chart-wrap"><canvas id="chart24h"></canvas></div>
  </div>

  <div class="section-title">üìÜ –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî 7 –¥–Ω–µ–π</div>
  <div class="card chart-card">
    <div class="chart-wrap"><canvas id="chart7d"></canvas></div>
  </div>

  <div class="section-title">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç—å ‚Äî 24 —á–∞—Å–∞</div>
  <div class="card chart-card">
    <div class="chart-wrap"><canvas id="chartTH"></canvas></div>
  </div>

</main>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  –¢–ï–ú–ê
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme() {
  const dark = document.body.classList.toggle('dark');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  const btn = document.querySelector('.theme-btn');
  btn.textContent = dark ? '‚òÄÔ∏è –¢–µ–º–∞' : 'üåô –¢–µ–º–∞';
}
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  document.querySelector('.theme-btn').textContent = '‚òÄÔ∏è –¢–µ–º–∞';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  –ü–ê–†–°–ò–ù–ì CSV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCSV(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  const header = lines[0];
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–±—ã ‚Äî —Ç–∞–±, –∏–Ω–∞—á–µ –ø—Ä–æ–±–µ–ª
  const sep = header.includes('\t') ? '\t' : /\s+/;

  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(sep === '\t' ? '\t' : /\s+/);
    if (parts.length < 6) continue;

    const dateStr = parts[0]; // DD.MM.YY
    const timeStr = parts[1]; // HH:MM
    const dist    = toNum(parts[2]);
    const temp    = toNum(parts[3]);
    const hum     = toNum(parts[4]);
    const bat     = toNum(parts[5]);

    if (isNaN(dist) || isNaN(temp) || isNaN(hum) || isNaN(bat)) continue;

    // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É: DD.MM.YY
    const [dd, mm, yy] = dateStr.split('.');
    if (!dd || !mm || !yy) continue;
    const [hh, mi] = timeStr.split(':');
    const dt = new Date(2000 + parseInt(yy), parseInt(mm) - 1, parseInt(dd),
                        parseInt(hh), parseInt(mi));
    if (isNaN(dt.getTime())) continue;

    rows.push({ dt, dist, temp, hum, bat });
  }

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  rows.sort((a, b) => a.dt - b.dt);
  return rows;
}

function toNum(s) {
  if (!s) return NaN;
  return parseFloat(s.replace(',', '.'));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ê–ù–û–ú–ê–õ–ò–ô
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isValidDist(d) {
  // –î–∞—Ç—á–∏–∫ —à–ª—ë—Ç -1 –∏–ª–∏ ~0.203-0.204 –∫–∞–∫ –æ—à–∏–±–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  // –†–µ–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: 0.4 ‚Äì 1.0 –º (–≥—Ä—É–±–æ)
  return d >= 0.35 && d <= 1.5;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CHART DEFAULTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function chartDefaults() {
  const dark = document.body.classList.contains('dark');
  return {
    gridColor: dark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)',
    textColor: dark ? '#94a3b8' : '#64748b',
  };
}

function makeLineChart(id, labels, datasets) {
  const { gridColor, textColor } = chartDefaults();
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: datasets.length > 1,
          labels: { color: textColor, font: { size: 12 }, boxWidth: 12 }
        },
        tooltip: { callbacks: {} }
      },
      scales: {
        x: {
          ticks: { color: textColor, maxTicksLimit: 8, maxRotation: 0 },
          grid: { color: gridColor }
        },
        y: {
          ticks: { color: textColor },
          grid: { color: gridColor }
        }
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GAUGE ‚Äî –ø–æ–ª—É–∫—Ä—É–≥
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBatGauge(canvasId, value, min, max) {
  const pct = Math.max(0, Math.min(1, (value - min) / (max - min)));
  const color = pct > 0.6 ? '#22c55e' : pct > 0.3 ? '#f59e0b' : '#ef4444';
  const dark = document.body.classList.contains('dark');
  const bg = dark ? '#334155' : '#e2e8f0';

  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const cx = w / 2, cy = h - 4;
  const r = Math.min(cx, cy) - 4;

  // –§–æ–Ω
  ctx.beginPath();
  ctx.arc(cx, cy, r, Math.PI, 0);
  ctx.lineWidth = 10;
  ctx.strokeStyle = bg;
  ctx.stroke();

  // –ó–Ω–∞—á–µ–Ω–∏–µ
  ctx.beginPath();
  ctx.arc(cx, cy, r, Math.PI, Math.PI + pct * Math.PI);
  ctx.strokeStyle = color;
  ctx.stroke();
}

function drawLevelGauge(value, color) {
  const canvas = document.getElementById('levelGauge');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const cx = w / 2, cy = h / 2;
  const r = 48;
  const dark = document.body.classList.contains('dark');
  const bg = dark ? '#334155' : '#e2e8f0';

  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.lineWidth = 10;
  ctx.strokeStyle = bg;
  ctx.stroke();

  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º: 0.5 = –º–∏–Ω, 0.75 = –º–∞–∫—Å (–ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω)
  const pct = Math.max(0, Math.min(1, (value - 0.4) / (0.75 - 0.4)));

  ctx.beginPath();
  ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + pct * Math.PI * 2);
  ctx.strokeStyle = color;
  ctx.lineCap = 'round';
  ctx.stroke();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  –ü–†–û–ì–ù–û–ó: —Å—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å Œî
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildForecast(rows, currentLevel, currentDt) {
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞ —Å—É—Ç–æ–∫ ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∑–∞ —á–∞—Å
  const deltas = Array.from({ length: 24 }, () => []);
  const valid = rows.filter(r => isValidDist(r.dist));

  for (let i = 1; i < valid.length; i++) {
    const prev = valid[i - 1];
    const cur  = valid[i];
    const dtMs = cur.dt - prev.dt;
    // –¢–æ–ª—å–∫–æ —Å–º–µ–∂–Ω—ã–µ —Ç–æ—á–∫–∏ (–Ω–µ –±–æ–ª–µ–µ 2—á —Ä–∞–∑—Ä—ã–≤)
    if (dtMs <= 0 || dtMs > 2 * 3600 * 1000) continue;
    const dtH = dtMs / 3600000;
    const delta = (cur.dist - prev.dist) / dtH; // –º/—á–∞—Å
    const hour  = cur.dt.getHours();
    deltas[hour].push(delta);
  }

  // –°—Ä–µ–¥–Ω–∏–π –¥–µ–ª—å—Ç–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —á–∞—Å—É
  const avgDelta = deltas.map(arr => {
    if (arr.length === 0) return 0;
    return arr.reduce((s, x) => s + x, 0) / arr.length;
  });

  // –≠–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è –≤–ø–µ—Ä—ë–¥
  function foreachTarget(target) {
    let level = currentLevel;
    let dt = new Date(currentDt);
    const maxHours = 7 * 24;

    for (let h = 0; h < maxHours; h++) {
      const hour = dt.getHours();
      const d = avgDelta[hour];
      level += d; // –∑–∞ 1 —á–∞—Å
      dt = new Date(dt.getTime() + 3600000);

      const reached = target > currentLevel ? level >= target : level <= target;
      if (reached) {
        return dt.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
      }
    }
    return '–Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ –±–ª–∏–∂. 7–¥';
  }

  return {
    high: foreachTarget(0.65),
    low:  foreachTarget(0.50),
  };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  –í–û–ó–†–ê–°–¢ –î–ê–ù–ù–´–•
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatAge(ms) {
  const m = Math.round(ms / 60000);
  if (m < 60) return `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${m} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  const h = Math.round(m / 60);
  return `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${h} —á –Ω–∞–∑–∞–¥`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAIN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHEET_ID = '1iwjEdSiXEiLN6kiji0PIn24oQN2F-iC1ohLq_dMh7iQ';
const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

let charts = {};

async function loadData() {
  const res  = await fetch(CSV_URL);
  const text = await res.text();
  const rows = parseCSV(text);

  if (rows.length === 0) {
    document.getElementById('loader').innerHTML = '<p style="color:red">–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã</p>';
    return;
  }

  const now   = new Date();
  const last  = rows[rows.length - 1];

  // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
  document.getElementById('loader').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';

  // ‚îÄ‚îÄ –í–æ–∑—Ä–∞—Å—Ç –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ
  document.getElementById('dataAge').textContent = formatAge(now - last.dt);

  // ‚îÄ‚îÄ –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ ‚îÄ‚îÄ
  document.getElementById('tempNow').textContent = last.temp.toFixed(1) + ' ¬∞C';
  document.getElementById('humNow').textContent  = last.hum.toFixed(1)  + ' %';

  // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–ª–∏–¥–Ω—ã–π dist
  let lastValid = null;
  for (let i = rows.length - 1; i >= 0; i--) {
    if (isValidDist(rows[i].dist)) { lastValid = rows[i]; break; }
  }

  // ‚îÄ‚îÄ –£—Ä–æ–≤–µ–Ω—å ‚îÄ‚îÄ
  if (lastValid) {
    const lv = lastValid.dist;
    document.getElementById('levelNum').textContent = lv.toFixed(3);

    let color, statusClass, statusText;
    if (lv > 0.65) {
      color = '#22c55e'; statusClass = 'status-green'; statusText = 'üü¢ –í—ã—Å–æ–∫–∏–π';
    } else if (lv >= 0.50) {
      color = '#f59e0b'; statusClass = 'status-yellow'; statusText = 'üü° –°—Ä–µ–¥–Ω–∏–π';
    } else {
      color = '#ef4444'; statusClass = 'status-red'; statusText = 'üî¥ –ù–∏–∑–∫–∏–π';
    }

    const statusEl = document.getElementById('levelStatus');
    statusEl.textContent    = statusText;
    statusEl.className      = 'level-status ' + statusClass;

    drawLevelGauge(lv, color);

    // –°—Ä–µ–¥–Ω–µ–µ –≤ —ç—Ç–æ—Ç —á–∞—Å –∑–∞ 7 –¥–Ω–µ–π
    const h7ago = new Date(now - 7 * 86400000);
    const hourNow = now.getHours();
    const sameHour = rows.filter(r =>
      r.dt > h7ago &&
      r.dt.getHours() === hourNow &&
      isValidDist(r.dist)
    );
    if (sameHour.length) {
      const avg = sameHour.reduce((s, r) => s + r.dist, 0) / sameHour.length;
      document.getElementById('avgSameHour').textContent = avg.toFixed(3) + ' –º';
    } else {
      document.getElementById('avgSameHour').textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    }

    // –ü—Ä–æ–≥–Ω–æ–∑
    const fc = buildForecast(rows, lv, lastValid.dt);
    document.getElementById('forecastHigh').textContent = lv >= 0.65 ? '—É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç' : fc.high;
    document.getElementById('forecastLow').textContent  = lv <= 0.50 ? '—É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç' : fc.low;
  }

  // ‚îÄ‚îÄ –ë–∞—Ç–∞—Ä–µ—è ‚îÄ‚îÄ
  const batV = last.bat;
  const BAT_MIN = 3.1, BAT_MAX = 4.1;
  const batPct = Math.round(Math.max(0, Math.min(1, (batV - BAT_MIN) / (BAT_MAX - BAT_MIN))) * 100);
  document.getElementById('batVal').textContent = batV.toFixed(2) + ' –í';
  document.getElementById('batStatus').textContent = batPct + '% –∑–∞—Ä—è–¥–∞';
  drawBatGauge('batGauge', batV, BAT_MIN, BAT_MAX);

  // ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫ 24—á ‚îÄ‚îÄ
  const ms24 = now - 24 * 3600000;
  const rows24 = rows.filter(r => r.dt > ms24 && isValidDist(r.dist));
  const lbl24  = rows24.map(r => `${r.dt.getHours().toString().padStart(2,'0')}:${r.dt.getMinutes().toString().padStart(2,'0')}`);
  const dat24  = rows24.map(r => r.dist);

  if (charts.c24) charts.c24.destroy();
  charts.c24 = makeLineChart('chart24h', lbl24, [{
    label: '–£—Ä–æ–≤–µ–Ω—å (–º)',
    data: dat24,
    borderColor: '#3b82f6',
    backgroundColor: 'rgba(59,130,246,0.1)',
    fill: true,
    tension: 0.3,
    pointRadius: 3,
    pointHoverRadius: 5,
  }]);

  // ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫ 7 –¥–Ω–µ–π (—Å—Ä–µ–¥–Ω–∏–π –∑–∞ —Å—É—Ç–∫–∏) ‚îÄ‚îÄ
  const ms7 = now - 7 * 86400000;
  const byDay = {};
  rows.filter(r => r.dt > ms7 && isValidDist(r.dist)).forEach(r => {
    const key = `${r.dt.getDate().toString().padStart(2,'0')}.${(r.dt.getMonth()+1).toString().padStart(2,'0')}`;
    if (!byDay[key]) byDay[key] = [];
    byDay[key].push(r.dist);
  });
  const lbl7 = Object.keys(byDay);
  const dat7 = lbl7.map(k => +(byDay[k].reduce((s,x)=>s+x,0)/byDay[k].length).toFixed(4));

  if (charts.c7) charts.c7.destroy();
  charts.c7 = makeLineChart('chart7d', lbl7, [{
    label: '–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (–º)',
    data: dat7,
    borderColor: '#10b981',
    backgroundColor: 'rgba(16,185,129,0.1)',
    fill: true,
    tension: 0.3,
    pointRadius: 5,
    pointHoverRadius: 7,
  }]);

  // ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫ —Ç–µ–º–ø + –≤–ª–∞–∂–Ω–æ—Å—Ç—å 24—á ‚îÄ‚îÄ
  const rowsTH = rows.filter(r => r.dt > ms24);
  const lblTH  = rowsTH.map(r => `${r.dt.getHours().toString().padStart(2,'0')}:${r.dt.getMinutes().toString().padStart(2,'0')}`);

  if (charts.cTH) charts.cTH.destroy();
  charts.cTH = makeLineChart('chartTH', lblTH, [
    {
      label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
      data: rowsTH.map(r => r.temp),
      borderColor: '#f97316',
      backgroundColor: 'rgba(249,115,22,0.08)',
      fill: false,
      tension: 0.3,
      pointRadius: 2,
      yAxisID: 'yT',
    },
    {
      label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',
      data: rowsTH.map(r => r.hum),
      borderColor: '#06b6d4',
      backgroundColor: 'rgba(6,182,212,0.08)',
      fill: false,
      tension: 0.3,
      pointRadius: 2,
      yAxisID: 'yH',
    }
  ]);

  // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä—É—é –æ—Å—å –∫ –≥—Ä–∞—Ñ–∏–∫—É TH
  charts.cTH.options.scales = {
    ...charts.cTH.options.scales,
    yT: {
      type: 'linear', position: 'left',
      ticks: { color: '#f97316' },
      grid: { color: chartDefaults().gridColor }
    },
    yH: {
      type: 'linear', position: 'right',
      ticks: { color: '#06b6d4' },
      grid: { drawOnChartArea: false }
    },
    x: charts.cTH.options.scales.x,
  };
  delete charts.cTH.options.scales.y;
  charts.cTH.update();
}

// –ó–∞–ø—É—Å–∫ + –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
loadData().catch(e => {
  document.getElementById('loader').innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
});
setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
