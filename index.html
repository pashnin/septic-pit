
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ª–∏–≤–Ω–∞—è —è–º–∞</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:#f0f4f8; --surface:#fff; --surface2:#f8fafc;
  --border:#e2e8f0; --text:#1e293b; --text2:#64748b;
  --accent:#3b82f6; --shadow:0 2px 12px rgba(0,0,0,.08);
}
body.dark {
  --bg:#0f172a; --surface:#1e293b; --surface2:#273449;
  --border:#334155; --text:#f1f5f9; --text2:#94a3b8;
  --shadow:0 2px 16px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;transition:background .3s,color .3s;min-height:100vh}

header{background:var(--surface);border-bottom:1px solid var(--border);padding:13px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.h-left{display:flex;align-items:center;gap:9px;font-size:17px;font-weight:700}
.h-right{display:flex;align-items:center;gap:8px}
#dataAge{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);padding:4px 10px;border-radius:20px}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 13px;border-radius:20px;cursor:pointer;font-size:13px;transition:.2s}
.btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

main{max-width:920px;margin:0 auto;padding:18px 14px 40px}
.sec{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin:22px 0 10px}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:13px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px}

.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);transition:background .3s}
.lbl{font-size:11px;color:var(--text2);font-weight:500;margin-bottom:7px}
.val{font-size:26px;font-weight:800;line-height:1}
.sub{font-size:12px;color:var(--text2);margin-top:5px}

/* –£—Ä–æ–≤–µ–Ω—å */
.level-card{grid-column:span 2;display:flex;align-items:center;gap:20px;padding:20px 22px}
.lv-wrap{position:relative;width:110px;height:110px;flex-shrink:0}
.lv-wrap canvas{position:absolute;top:0;left:0}
.lv-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.lv-num{font-size:21px;font-weight:800;line-height:1}
.lv-unit{font-size:10px;color:var(--text2);margin-top:2px}
.lv-info{flex:1}
.lv-info h2{font-size:15px;font-weight:700;margin-bottom:7px}
.badge{display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:600;padding:4px 12px;border-radius:20px;margin-bottom:9px}
.sg{background:#dcfce7;color:#15803d} body.dark .sg{background:#14532d;color:#86efac}
.sy{background:#fef9c3;color:#a16207} body.dark .sy{background:#451a03;color:#fcd34d}
.sr{background:#fee2e2;color:#b91c1c} body.dark .sr{background:#450a0a;color:#fca5a5}
.avg-row{font-size:12px;color:var(--text2)}
.avg-row b{color:var(--text)}

/* –ë–∞—Ç–∞—Ä–µ—è */
.bat-card{text-align:center}
.bat-wrap{position:relative;width:92px;height:56px;margin:6px auto 2px}
.bat-num{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:13px;font-weight:700;white-space:nowrap}

/* –ü—Ä–æ–≥–Ω–æ–∑ */
.fc-card{border-left:3px solid var(--accent)}
.fc-to{font-size:10px;color:var(--text2);margin-bottom:3px}
.fc-val{font-size:13px;font-weight:700;line-height:1.4}
.fc-note{font-size:11px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin-top:11px;line-height:1.6}

/* –ì—Ä–∞—Ñ–∏–∫–∏ */
.chart-card{padding:18px}
.chart-wrap{position:relative;height:195px}

/* –û—à–∏–±–∫–∞ */
#errBox{display:none;background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;border-radius:12px;padding:14px 18px;margin:20px 14px;font-size:14px;line-height:1.5}

/* –õ–æ–∞–¥–µ—Ä */
#loader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:14px}
.spin{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader p{color:var(--text2);font-size:14px}

@media(max-width:640px){
  .g4{grid-template-columns:1fr 1fr}
  .g2{grid-template-columns:1fr}
  .level-card{grid-column:span 1;flex-direction:column;text-align:center}
  .lv-info h2{display:none}
  .chart-wrap{height:155px}
  .val{font-size:22px}
}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</p></div>
<div id="errBox"></div>

<header>
  <div class="h-left">üè† –°–ª–∏–≤–Ω–∞—è —è–º–∞</div>
  <div class="h-right">
    <span id="dataAge">‚Äî</span>
    <button class="btn" onclick="toggleTheme()">üåô –¢–µ–º–∞</button>
  </div>
</header>

<main id="app" style="display:none">

  <div class="sec">üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
  <div class="g2">
    <div class="card level-card">
      <div class="lv-wrap">
        <canvas id="lvGauge" width="110" height="110"></canvas>
        <div class="lv-center">
          <div class="lv-num" id="lvNum">‚Äî</div>
          <div class="lv-unit">–º–µ—Ç—Ä—ã</div>
        </div>
      </div>
      <div class="lv-info">
        <h2>–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã</h2>
        <div class="badge" id="lvBadge">‚Äî</div>
        <div class="avg-row">–°—Ä–µ–¥–Ω–µ–µ –≤ —ç—Ç–æ—Ç —á–∞—Å (7–¥): <b id="avgHour">‚Äî</b></div>
      </div>
    </div>

    <div class="card bat-card">
      <div class="lbl">üîã –ë–∞—Ç–∞—Ä–µ—è</div>
      <div class="bat-wrap">
        <canvas id="batGauge" width="92" height="56"></canvas>
        <div class="bat-num" id="batNum">‚Äî</div>
      </div>
      <div class="sub" id="batSub">‚Äî</div>
    </div>
  </div>

  <div class="g4" style="margin-top:13px">
    <div class="card">
      <div class="lbl">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
      <div class="val" id="tempVal">‚Äî</div>
      <div class="sub">¬∞C –≤ —è–º–µ</div>
    </div>
    <div class="card">
      <div class="lbl">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
      <div class="val" id="humVal">‚Äî</div>
      <div class="sub">% RH</div>
    </div>
    <div class="card fc-card">
      <div class="lbl">üìà –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí 0.65 –º</div>
      <div class="fc-to">–î–æ—Å—Ç–∏–≥–Ω–µ—Ç ¬´–≤—ã—Å–æ–∫–∏–π¬ª</div>
      <div class="fc-val" id="fc65">‚Äî</div>
    </div>
    <div class="card fc-card">
      <div class="lbl">üìâ –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí 0.50 –º</div>
      <div class="fc-to">–î–æ—Å—Ç–∏–≥–Ω–µ—Ç ¬´–Ω–∏–∑–∫–∏–π¬ª</div>
      <div class="fc-val" id="fc50">‚Äî</div>
    </div>
  </div>

  <div class="fc-note">
    <b>–ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞:</b> –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ 24 —á–∞—Å–æ–≤ —Å—É—Ç–æ–∫ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è (–º/—á–∞—Å) –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.
    –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —à–∞–≥–∞–µ—Ç—Å—è –≤–ø–µ—Ä—ë–¥ –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é –¥–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞.
  </div>

  <div class="sec">üìâ –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã ‚Äî 24 —á–∞—Å–∞</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="c24"></canvas></div></div>

  <div class="sec">üìÜ –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî 7 –¥–Ω–µ–π</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="c7d"></canvas></div></div>

  <div class="sec">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç—å ‚Äî 24 —á–∞—Å–∞</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="cTH"></canvas></div></div>

</main>

<script>
// ‚îÄ‚îÄ –¢–ï–ú–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme() {
  const d = document.body.classList.toggle('dark');
  localStorage.setItem('theme', d ? 'dark' : 'light');
  document.querySelector('.btn').textContent = d ? '‚òÄÔ∏è –¢–µ–º–∞' : 'üåô –¢–µ–º–∞';
}
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  document.querySelector('.btn').textContent = '‚òÄÔ∏è –¢–µ–º–∞';
}

// ‚îÄ‚îÄ –ü–ê–†–°–ò–ù–ì ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏: "DD.MM.YY H:MM 0,676 0,8 13 4,1"
// –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ‚Äî –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª–æ–≤/—Ç–∞–±–æ–≤
function n(s) { return parseFloat((s || '').trim().replace(',', '.')); }

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

  // –ù–∞–π–¥—ë–º —Å—Ç—Ä–æ–∫—É-–∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–∞ date –∏ dist)
  let hi = -1;
  for (let i = 0; i < lines.length; i++) {
    if (/date/i.test(lines[i]) && /dist/i.test(lines[i])) { hi = i; break; }
  }
  // –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫)
  if (hi === -1) {
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].trim()) { hi = i; break; }
    }
  }

  const rows = [];
  for (let i = hi + 1; i < lines.length; i++) {
    const raw = lines[i].trim();
    if (!raw) continue;

    // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º/—Ç–∞–±–∞–º
    const p = raw.split(/\s+/);
    if (p.length < 6) continue;

    // p[0] = DD.MM.YY  p[1] = H:MM  p[2]=dist  p[3]=temp  p[4]=hum  p[5]=bat
    const dp = p[0].split('.');
    if (dp.length < 3) continue;

    const dd = parseInt(dp[0], 10);
    const mm = parseInt(dp[1], 10) - 1;
    const yy = parseInt(dp[2], 10);
    const yr = yy < 100 ? 2000 + yy : yy;

    const tp = p[1].split(':');
    const hh = parseInt(tp[0], 10);
    const mi = parseInt(tp[1] || '0', 10);

    const dt = new Date(yr, mm, dd, hh, mi, 0);
    if (isNaN(dt.getTime())) continue;

    const dist = n(p[2]);
    const temp = n(p[3]);
    const hum  = n(p[4]);
    const bat  = n(p[5]);

    if (isNaN(dist) || isNaN(temp) || isNaN(hum) || isNaN(bat)) continue;

    rows.push({ dt, dist, temp, hum, bat });
  }

  rows.sort((a, b) => a.dt - b.dt);
  return rows;
}

// –í–∞–ª–∏–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–∞—Ç—á–∏–∫–∞: 0.204 –∏ -1 ‚Äî –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
function okDist(d) { return d >= 0.35 && d <= 1.5; }

// ‚îÄ‚îÄ CANVAS: –∫—Ä—É–≥–æ–≤–æ–π gauge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawCircle(canvasId, pct, color) {
  const dark = document.body.classList.contains('dark');
  const bg   = dark ? '#334155' : '#e2e8f0';
  const cv   = document.getElementById(canvasId);
  const ctx  = cv.getContext('2d');
  const w = cv.width, h = cv.height;
  ctx.clearRect(0, 0, w, h);
  const cx = w / 2, cy = h / 2, r = Math.min(cx, cy) - 8;
  ctx.lineWidth = 10; ctx.lineCap = 'round';
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.strokeStyle = bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + pct * Math.PI * 2);
  ctx.strokeStyle = color; ctx.stroke();
}

// ‚îÄ‚îÄ CANVAS: –ø–æ–ª—É–∫—Ä—É–≥ –±–∞—Ç–∞—Ä–µ–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBat(pct, color) {
  const dark = document.body.classList.contains('dark');
  const bg   = dark ? '#334155' : '#e2e8f0';
  const cv   = document.getElementById('batGauge');
  const ctx  = cv.getContext('2d');
  const w = cv.width, h = cv.height;
  ctx.clearRect(0, 0, w, h);
  const cx = w / 2, cy = h - 4, r = cx - 6;
  ctx.lineWidth = 9; ctx.lineCap = 'round';
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, 0);
  ctx.strokeStyle = bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, Math.PI + pct * Math.PI);
  ctx.strokeStyle = color; ctx.stroke();
}

// ‚îÄ‚îÄ CHART HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const charts = {};
function mkChart(id, labels, datasets, extraScales) {
  const dark = document.body.classList.contains('dark');
  const gc = dark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.05)';
  const tc = dark ? '#94a3b8' : '#64748b';
  const baseScales = {
    x: { ticks: { color: tc, maxTicksLimit: 8, maxRotation: 0 }, grid: { color: gc } },
    y: { ticks: { color: tc }, grid: { color: gc } }
  };
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: datasets.length > 1, labels: { color: tc, font: { size: 11 }, boxWidth: 10 } } },
      scales: extraScales || baseScales
    }
  });
}

// ‚îÄ‚îÄ –ü–†–û–ì–ù–û–ó: —Å—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å Œî ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildForecast(rows, curLevel, curDt) {
  const valid  = rows.filter(r => okDist(r.dist));
  const deltas = Array.from({ length: 24 }, () => []);

  for (let i = 1; i < valid.length; i++) {
    const a = valid[i - 1], b = valid[i];
    const ms = b.dt - a.dt;
    if (ms <= 0 || ms > 2 * 3600000) continue;
    deltas[b.dt.getHours()].push((b.dist - a.dist) / (ms / 3600000));
  }

  const avg = deltas.map(arr => arr.length ? arr.reduce((s, x) => s + x, 0) / arr.length : 0);

  function reach(target) {
    let lv = curLevel, dt = new Date(curDt);
    for (let h = 0; h < 7 * 24; h++) {
      lv += avg[dt.getHours()];
      dt  = new Date(dt.getTime() + 3600000);
      if (target > curLevel ? lv >= target : lv <= target)
        return dt.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
    }
    return '–Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è (7–¥)';
  }
  return { high: reach(0.65), low: reach(0.50) };
}

// ‚îÄ‚îÄ –í–û–ó–†–ê–°–¢ –î–ê–ù–ù–´–• ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtAge(ms) {
  const m = Math.round(ms / 60000);
  return m < 60 ? `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${m} –º–∏–Ω –Ω–∞–∑–∞–¥` : `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${Math.round(m / 60)} —á –Ω–∞–∑–∞–¥`;
}

// ‚îÄ‚îÄ –û–®–ò–ë–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showError(msg) {
  document.getElementById('loader').style.display = 'none';
  const b = document.getElementById('errBox');
  b.style.display = 'block';
  b.innerHTML = `‚ö†Ô∏è ${msg}`;
}

// ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  try {
    const res = await fetch('./data.csv?t=' + Date.now());
    if (!res.ok) throw new Error(`–§–∞–π–ª data.csv –Ω–µ –Ω–∞–π–¥–µ–Ω (HTTP ${res.status}). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.`);

    const text = await res.text();
    if (!text.trim()) throw new Error('–§–∞–π–ª data.csv –ø—É—Å—Ç–æ–π.');

    const rows = parseCSV(text);
    if (!rows.length) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–∑ data.csv.<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 –∫–æ–ª–æ–Ω–æ–∫ —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏.<br>–ü—Ä–∏–º–µ—Ä: <code>20.02.26 16:02 0,680 0,8 13,9 4,05</code>');

    document.getElementById('loader').style.display = 'none';
    document.getElementById('app').style.display = 'block';

    const now  = new Date();
    const last = rows[rows.length - 1];

    // –í–æ–∑—Ä–∞—Å—Ç
    document.getElementById('dataAge').textContent = fmtAge(now - last.dt);

    // –¢–µ–º–ø / –í–ª–∞–∂–Ω–æ—Å—Ç—å (–±–µ—Ä—ë–º –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –¥–∞—Ç—á–∏–∫ –≤—Å–µ–≥–¥–∞ –ø–∏—à–µ—Ç)
    document.getElementById('tempVal').textContent = last.temp.toFixed(1) + ' ¬∞C';
    document.getElementById('humVal').textContent  = last.hum.toFixed(1)  + ' %';

    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–ª–∏–¥–Ω—ã–π dist
    let lv = null, lvRow = null;
    for (let i = rows.length - 1; i >= 0; i--) {
      if (okDist(rows[i].dist)) { lv = rows[i].dist; lvRow = rows[i]; break; }
    }

    if (lv !== null) {
      document.getElementById('lvNum').textContent = lv.toFixed(3);

      let color, cls, label;
      if      (lv > 0.65) { color = '#22c55e'; cls = 'sg'; label = 'üü¢ –í—ã—Å–æ–∫–∏–π'; }
      else if (lv >= 0.50) { color = '#f59e0b'; cls = 'sy'; label = 'üü° –°—Ä–µ–¥–Ω–∏–π'; }
      else                 { color = '#ef4444'; cls = 'sr'; label = 'üî¥ –ù–∏–∑–∫–∏–π';  }

      const badge = document.getElementById('lvBadge');
      badge.textContent = label;
      badge.className   = 'badge ' + cls;

      // Gauge —É—Ä–æ–≤–Ω—è (0.40 = –º–∏–Ω, 0.75 = –º–∞–∫—Å –ø–æ –¥–∞–Ω–Ω—ã–º)
      const pctLv = Math.max(0, Math.min(1, (lv - 0.40) / (0.75 - 0.40)));
      drawCircle('lvGauge', pctLv, color);

      // –°—Ä–µ–¥–Ω–µ–µ –∑–∞ —ç—Ç–æ—Ç —á–∞—Å –∑–∞ 7–¥
      const ago7   = new Date(now - 7 * 86400000);
      const hrNow  = now.getHours();
      const same   = rows.filter(r => r.dt > ago7 && r.dt.getHours() === hrNow && okDist(r.dist));
      document.getElementById('avgHour').textContent =
        same.length ? (same.reduce((s, r) => s + r.dist, 0) / same.length).toFixed(3) + ' –º' : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

      // –ü—Ä–æ–≥–Ω–æ–∑
      const fc = buildForecast(rows, lv, lvRow.dt);
      document.getElementById('fc65').textContent = lv >= 0.65 ? '‚úÖ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç' : fc.high;
      document.getElementById('fc50').textContent = lv <= 0.50 ? '‚úÖ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç' : fc.low;
    }

    // –ë–∞—Ç–∞—Ä–µ—è
    const bat = last.bat;
    const BAT_MIN = 3.1, BAT_MAX = 4.1;
    const pctB  = Math.max(0, Math.min(1, (bat - BAT_MIN) / (BAT_MAX - BAT_MIN)));
    const batClr = pctB > 0.6 ? '#22c55e' : pctB > 0.3 ? '#f59e0b' : '#ef4444';
    drawBat(pctB, batClr);
    document.getElementById('batNum').textContent = bat.toFixed(2) + ' –í';
    document.getElementById('batSub').textContent = Math.round(pctB * 100) + '% –∑–∞—Ä—è–¥–∞';

    // ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dark = document.body.classList.contains('dark');
    const gc   = dark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.05)';
    const tc   = dark ? '#94a3b8' : '#64748b';

    function fmtTime(dt) {
      return String(dt.getHours()).padStart(2, '0') + ':' + String(dt.getMinutes()).padStart(2, '0');
    }

    // 24—á —É—Ä–æ–≤–µ–Ω—å
    const ms24 = now - 24 * 3600000;
    const r24  = rows.filter(r => r.dt > ms24 && okDist(r.dist));
    mkChart('c24', r24.map(r => fmtTime(r.dt)), [{
      label: '–£—Ä–æ–≤–µ–Ω—å (–º)', data: r24.map(r => r.dist),
      borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,.1)',
      fill: true, tension: .3, pointRadius: 2, pointHoverRadius: 5
    }]);

    // 7–¥ —Å—Ä–µ–¥–Ω–∏–π –∑–∞ —Å—É—Ç–∫–∏
    const ms7  = now - 7 * 86400000;
    const byDay = {};
    rows.filter(r => r.dt > ms7 && okDist(r.dist)).forEach(r => {
      const k = String(r.dt.getDate()).padStart(2, '0') + '.' + String(r.dt.getMonth() + 1).padStart(2, '0');
      (byDay[k] = byDay[k] || []).push(r.dist);
    });
    const lbl7 = Object.keys(byDay);
    const dat7 = lbl7.map(k => +(byDay[k].reduce((s, x) => s + x, 0) / byDay[k].length).toFixed(4));
    mkChart('c7d', lbl7, [{
      label: '–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (–º)', data: dat7,
      borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,.1)',
      fill: true, tension: .3, pointRadius: 5, pointHoverRadius: 7
    }]);

    // –¢–µ–º–ø + –≤–ª–∞–∂–Ω–æ—Å—Ç—å 24—á (–¥–≤–æ–π–Ω–∞—è –æ—Å—å)
    const rTH  = rows.filter(r => r.dt > ms24);
    const lblTH = rTH.map(r => fmtTime(r.dt));
    mkChart('cTH', lblTH, [
      {
        label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)', data: rTH.map(r => r.temp),
        borderColor: '#f97316', fill: false, tension: .3, pointRadius: 2, yAxisID: 'yT'
      },
      {
        label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)', data: rTH.map(r => r.hum),
        borderColor: '#06b6d4', fill: false, tension: .3, pointRadius: 2, yAxisID: 'yH'
      }
    ], {
      x:  { ticks: { color: tc, maxTicksLimit: 8, maxRotation: 0 }, grid: { color: gc } },
      yT: { type: 'linear', position: 'left',  ticks: { color: '#f97316' }, grid: { color: gc } },
      yH: { type: 'linear', position: 'right', ticks: { color: '#06b6d4' }, grid: { drawOnChartArea: false } }
    });

  } catch (e) {
    showError(e.message);
    console.error(e);
  }
}

loadData();
setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
