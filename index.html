
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ª–∏–≤–Ω–∞—è —è–º–∞</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:#f0f4f8; --surface:#fff; --surface2:#f8fafc;
  --border:#e2e8f0; --text:#1e293b; --text2:#64748b;
  --accent:#3b82f6; --shadow:0 2px 12px rgba(0,0,0,.08);
  --green:#22c55e; --yellow:#f59e0b; --red:#ef4444;
}
body.dark {
  --bg:#0f172a; --surface:#1e293b; --surface2:#273449;
  --border:#334155; --text:#f1f5f9; --text2:#94a3b8;
  --shadow:0 2px 16px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;transition:background .3s,color .3s;min-height:100vh}

/* HEADER */
header{background:var(--surface);border-bottom:1px solid var(--border);padding:13px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.h-left{display:flex;align-items:center;gap:9px;font-size:17px;font-weight:700}
.h-right{display:flex;align-items:center;gap:8px}
#dataAge{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);padding:4px 10px;border-radius:20px}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 13px;border-radius:20px;cursor:pointer;font-size:13px;transition:.2s}
.btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

/* MAIN */
main{max-width:920px;margin:0 auto;padding:18px 14px 40px}
.sec{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin:22px 0 10px}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:13px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:13px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px}

/* CARD */
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);transition:background .3s}
.lbl{font-size:11px;color:var(--text2);font-weight:500;margin-bottom:7px;display:flex;align-items:center;gap:5px}
.val{font-size:26px;font-weight:800;line-height:1}
.sub{font-size:12px;color:var(--text2);margin-top:5px}

/* LEVEL CARD */
.level-card{grid-column:span 2;display:flex;align-items:center;gap:20px;padding:20px 22px}
.lv-wrap{position:relative;width:110px;height:110px;flex-shrink:0}
.lv-wrap canvas{position:absolute;top:0;left:0}
.lv-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.lv-num{font-size:21px;font-weight:800;line-height:1}
.lv-unit{font-size:10px;color:var(--text2);margin-top:2px}
.lv-info{flex:1}
.lv-info h2{font-size:15px;font-weight:700;margin-bottom:7px}
.status-badge{display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:600;padding:4px 12px;border-radius:20px;margin-bottom:9px}
.sg{background:#dcfce7;color:#15803d} body.dark .sg{background:#14532d;color:#86efac}
.sy{background:#fef9c3;color:#a16207} body.dark .sy{background:#451a03;color:#fcd34d}
.sr{background:#fee2e2;color:#b91c1c} body.dark .sr{background:#450a0a;color:#fca5a5}
.avg-row{font-size:12px;color:var(--text2)}
.avg-row b{color:var(--text)}

/* BATTERY */
.bat-card{text-align:center}
.bat-wrap{position:relative;width:92px;height:56px;margin:6px auto 0}
.bat-num{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:13px;font-weight:700;white-space:nowrap}

/* FORECAST */
.fc-card{border-left:3px solid var(--accent)}
.fc-to{font-size:10px;color:var(--text2);margin-bottom:3px}
.fc-val{font-size:14px;font-weight:700;line-height:1.3}
.fc-note{font-size:11px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin-top:11px;line-height:1.5}

/* CHARTS */
.chart-card{padding:18px}
.chart-wrap{position:relative;height:195px}

/* ERROR */
#errBox{display:none;background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;border-radius:12px;padding:14px 18px;margin:20px 14px;font-size:14px}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:14px}
.spin{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader p{color:var(--text2);font-size:14px}

/* RESPONSIVE */
@media(max-width:640px){
  .g4{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr}
  .g2{grid-template-columns:1fr}
  .level-card{grid-column:span 1;flex-direction:column;text-align:center}
  .lv-info h2{display:none}
  .chart-wrap{height:155px}
  .val{font-size:22px}
}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</p></div>
<div id="errBox"></div>

<header>
  <div class="h-left">üè† –°–ª–∏–≤–Ω–∞—è —è–º–∞</div>
  <div class="h-right">
    <span id="dataAge">‚Äî</span>
    <button class="btn" onclick="toggleTheme()">üåô –¢–µ–º–∞</button>
  </div>
</header>

<main id="app" style="display:none">

  <div class="sec">üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
  <div class="g2">

    <!-- –£—Ä–æ–≤–µ–Ω—å -->
    <div class="card level-card">
      <div class="lv-wrap">
        <canvas id="lvGauge" width="110" height="110"></canvas>
        <div class="lv-center">
          <div class="lv-num" id="lvNum">‚Äî</div>
          <div class="lv-unit">–º–µ—Ç—Ä—ã</div>
        </div>
      </div>
      <div class="lv-info">
        <h2>–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã</h2>
        <div class="status-badge" id="lvBadge">‚Äî</div>
        <div class="avg-row">–°—Ä–µ–¥–Ω–µ–µ –≤ —ç—Ç–æ—Ç —á–∞—Å (7–¥): <b id="avgHour">‚Äî</b></div>
      </div>
    </div>

    <!-- –ë–∞—Ç–∞—Ä–µ—è -->
    <div class="card bat-card">
      <div class="lbl">üîã –ë–∞—Ç–∞—Ä–µ—è</div>
      <div class="bat-wrap">
        <canvas id="batGauge" width="92" height="56"></canvas>
        <div class="bat-num" id="batNum">‚Äî</div>
      </div>
      <div class="sub" id="batSub">‚Äî</div>
    </div>

  </div>

  <!-- –¢–µ–º–ø / –í–ª–∞–∂–Ω–æ—Å—Ç—å / –ü—Ä–æ–≥–Ω–æ–∑—ã -->
  <div class="g4" style="margin-top:13px">
    <div class="card">
      <div class="lbl">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
      <div class="val" id="tempVal">‚Äî</div>
      <div class="sub">¬∞C –≤ —è–º–µ</div>
    </div>
    <div class="card">
      <div class="lbl">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
      <div class="val" id="humVal">‚Äî</div>
      <div class="sub">% RH</div>
    </div>
    <div class="card fc-card">
      <div class="lbl">üìà ‚Üí 0.65 –º</div>
      <div class="fc-to">–î–æ—Å—Ç–∏–≥–Ω–µ—Ç ¬´–≤—ã—Å–æ–∫–∏–π¬ª</div>
      <div class="fc-val" id="fc65">‚Äî</div>
    </div>
    <div class="card fc-card">
      <div class="lbl">üìâ ‚Üí 0.50 –º</div>
      <div class="fc-to">–î–æ—Å—Ç–∏–≥–Ω–µ—Ç ¬´–Ω–∏–∑–∫–∏–π¬ª</div>
      <div class="fc-val" id="fc50">‚Äî</div>
    </div>
  </div>

  <div class="fc-note">
    <b>–ü—Ä–æ–≥–Ω–æ–∑:</b> —Å—É—Ç–æ—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å Œî –∑–∞ 7 –¥–Ω–µ–π ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞ —Å—É—Ç–æ–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å—Ä–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è (–º/—á–∞—Å).
    –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–∫—Å—Ç—Ä–∞–ø–æ–ª–∏—Ä—É–µ—Ç—Å—è –≤–ø–µ—Ä—ë–¥ –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é –¥–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞.
  </div>

  <div class="sec">üìâ –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã ‚Äî 24 —á–∞—Å–∞</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="c24"></canvas></div></div>

  <div class="sec">üìÜ –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å ‚Äî 7 –¥–Ω–µ–π</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="c7d"></canvas></div></div>

  <div class="sec">üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç—å ‚Äî 24 —á–∞—Å–∞</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="cTH"></canvas></div></div>

</main>

<script>
// ‚îÄ‚îÄ –¢–ï–ú–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme(){
  const d=document.body.classList.toggle('dark');
  localStorage.setItem('theme',d?'dark':'light');
  document.querySelector('.btn').textContent=d?'‚òÄÔ∏è –¢–µ–º–∞':'üåô –¢–µ–º–∞';
}
if(localStorage.getItem('theme')==='dark'){
  document.body.classList.add('dark');
  document.querySelector('.btn').textContent='‚òÄÔ∏è –¢–µ–º–∞';
}

// ‚îÄ‚îÄ –ü–ê–†–°–ò–ù–ì ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toNum(s){ return parseFloat((s||'').replace(',','.')); }

function parseCSV(text){
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
  const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');

  // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É-–∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Å–æ–¥–µ—Ä–∂–∏—Ç "date" –∏–ª–∏ "dist")
  let headerIdx = -1;
  for(let i=0;i<lines.length;i++){
    const l=lines[i].toLowerCase();
    if(l.includes('date') && l.includes('dist')){ headerIdx=i; break; }
  }
  if(headerIdx===-1){
    // fallback: –ø–µ—Ä–≤–∞—è –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
    for(let i=0;i<lines.length;i++){
      if(lines[i].trim()) { headerIdx=i; break; }
    }
  }

  const rows=[];
  for(let i=headerIdx+1;i<lines.length;i++){
    const raw=lines[i].trim();
    if(!raw) continue;

    // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø—Ä–æ–±–µ–ª–∞–º/—Ç–∞–±–∞–º
    const parts=raw.split(/\s+/);
    if(parts.length<6) continue;

    const dateStr=parts[0]; // DD.MM.YY
    const timeStr=parts[1]; // H:MM –∏–ª–∏ HH:MM
    const dist=toNum(parts[2]);
    const temp=toNum(parts[3]);
    const hum =toNum(parts[4]);
    const bat =toNum(parts[5]);

    // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É DD.MM.YY
    const dp=dateStr.split('.');
    if(dp.length<3) continue;
    const dd=parseInt(dp[0],10);
    const mm=parseInt(dp[1],10)-1;
    const yy=parseInt(dp[2],10);
    const fullYear = yy < 100 ? 2000+yy : yy;

    const tp=timeStr.split(':');
    const hh=parseInt(tp[0],10);
    const mi=parseInt(tp[1]||'0',10);

    const dt=new Date(fullYear,mm,dd,hh,mi,0);
    if(isNaN(dt.getTime())) continue;
    if(isNaN(dist)||isNaN(temp)||isNaN(hum)||isNaN(bat)) continue;

    rows.push({dt,dist,temp,hum,bat});
  }

  rows.sort((a,b)=>a.dt-b.dt);
  return rows;
}

// ‚îÄ‚îÄ –§–ò–õ–¨–¢–† –ê–ù–û–ú–ê–õ–ò–ô ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 0.204/0.203/0.202 ‚Äî –¥–∞—Ç—á–∏–∫ –∑–∞—Å—Ç—Ä—è–ª, -1 ‚Äî –æ—à–∏–±–∫–∞
function validDist(d){ return d>=0.35 && d<=1.5; }

// ‚îÄ‚îÄ CANVAS GAUGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawArc(canvas, pct, color, lineW=10){
  const dark=document.body.classList.contains('dark');
  const bg=dark?'#334155':'#e2e8f0';
  const ctx=canvas.getContext('2d');
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2, r=Math.min(cx,cy)-lineW/2-2;
  // bg
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.lineWidth=lineW; ctx.strokeStyle=bg; ctx.stroke();
  // fill
  ctx.beginPath(); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+pct*Math.PI*2);
  ctx.strokeStyle=color; ctx.lineCap='round'; ctx.stroke();
}

function drawBat(canvas, pct, color){
  const dark=document.body.classList.contains('dark');
  const bg=dark?'#334155':'#e2e8f0';
  const ctx=canvas.getContext('2d');
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h-4, r=cx-6;
  ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,0);
  ctx.lineWidth=9; ctx.strokeStyle=bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,Math.PI+pct*Math.PI);
  ctx.strokeStyle=color; ctx.lineCap='round'; ctx.stroke();
}

// ‚îÄ‚îÄ CHART HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkChart(id, labels, datasets, opts={}){
  const dark=document.body.classList.contains('dark');
  const gc=dark?'rgba(255,255,255,.05)':'rgba(0,0,0,.05)';
  const tc=dark?'#94a3b8':'#64748b';
  const scales={
    x:{ticks:{color:tc,maxTicksLimit:8,maxRotation:0},grid:{color:gc}},
    y:{ticks:{color:tc},grid:{color:gc}}
  };
  return new Chart(document.getElementById(id),{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:datasets.length>1,labels:{color:tc,font:{size:11},boxWidth:10}}},
      scales: opts.scales||scales,
      ...opts
    }
  });
}

// ‚îÄ‚îÄ –ü–†–û–ì–ù–û–ó ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildForecast(rows, curLevel, curDt){
  const valid=rows.filter(r=>validDist(r.dist));
  const deltas=Array.from({length:24},()=>[]);

  for(let i=1;i<valid.length;i++){
    const prev=valid[i-1], cur=valid[i];
    const dtMs=cur.dt-prev.dt;
    if(dtMs<=0||dtMs>2*3600000) continue;
    const dh=dtMs/3600000;
    const delta=(cur.dist-prev.dist)/dh;
    deltas[cur.dt.getHours()].push(delta);
  }

  const avgDelta=deltas.map(arr=>arr.length?arr.reduce((s,x)=>s+x,0)/arr.length:0);

  function predict(target){
    let lv=curLevel, dt=new Date(curDt);
    for(let h=0;h<7*24;h++){
      lv+=avgDelta[dt.getHours()];
      dt=new Date(dt.getTime()+3600000);
      const hit=target>curLevel?lv>=target:lv<=target;
      if(hit) return dt.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    return '–Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ –±–ª–∏–∂. 7–¥';
  }
  return {high:predict(0.65), low:predict(0.50)};
}

// ‚îÄ‚îÄ –í–û–ó–†–ê–°–¢ –î–ê–ù–ù–´–• ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtAge(ms){
  const m=Math.round(ms/60000);
  if(m<60) return `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${m} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  return `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${Math.round(m/60)} —á –Ω–∞–∑–∞–¥`;
}

// ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHEET='1iwjEdSiXEiLN6kiji0PIn24oQN2F-iC1ohLq_dMh7iQ';
// –î–æ–±–∞–≤–ª—è–µ–º cachebust —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫—ç—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞
function csvUrl(){ return `https://docs.google.com/spreadsheets/d/${SHEET}/export?format=csv&t=${Date.now()}`; }

let charts={};

function showError(msg){
  document.getElementById('loader').style.display='none';
  const b=document.getElementById('errBox');
  b.style.display='block';
  b.textContent='‚ö†Ô∏è '+msg;
}

async function loadData(){
  try{
    const res=await fetch(csvUrl());
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const text=await res.text();

    const rows=parseCSV(text);
    if(!rows.length) throw new Error('–°—Ç—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è –≤—Å–µ—Ö).');

    document.getElementById('loader').style.display='none';
    document.getElementById('app').style.display='block';

    const now=new Date();
    const last=rows[rows.length-1];

    // –í–æ–∑—Ä–∞—Å—Ç –¥–∞–Ω–Ω—ã—Ö
    document.getElementById('dataAge').textContent=fmtAge(now-last.dt);

    // –¢–µ–º–ø / –í–ª–∞–∂–Ω–æ—Å—Ç—å
    document.getElementById('tempVal').textContent=last.temp.toFixed(1)+' ¬∞C';
    document.getElementById('humVal').textContent=last.hum.toFixed(1)+' %';

    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–ª–∏–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
    let lv=null, lvRow=null;
    for(let i=rows.length-1;i>=0;i--){
      if(validDist(rows[i].dist)){lv=rows[i].dist; lvRow=rows[i]; break;}
    }

    if(lv!==null){
      document.getElementById('lvNum').textContent=lv.toFixed(3);

      let color,cls,label;
      if(lv>0.65){color='#22c55e';cls='sg';label='üü¢ –í—ã—Å–æ–∫–∏–π';}
      else if(lv>=0.50){color='#f59e0b';cls='sy';label='üü° –°—Ä–µ–¥–Ω–∏–π';}
      else{color='#ef4444';cls='sr';label='üî¥ –ù–∏–∑–∫–∏–π';}

      const badge=document.getElementById('lvBadge');
      badge.textContent=label; badge.className='status-badge '+cls;

      // Gauge —É—Ä–æ–≤–Ω—è
      const pctLv=Math.max(0,Math.min(1,(lv-0.40)/(0.75-0.40)));
      drawArc(document.getElementById('lvGauge'),pctLv,color);

      // –°—Ä–µ–¥–Ω–µ–µ —Ç–æ–≥–æ –∂–µ —á–∞—Å–∞ –∑–∞ 7–¥
      const ago7=new Date(now-7*86400000);
      const hr=now.getHours();
      const sh=rows.filter(r=>r.dt>ago7&&r.dt.getHours()===hr&&validDist(r.dist));
      document.getElementById('avgHour').textContent=
        sh.length ? (sh.reduce((s,r)=>s+r.dist,0)/sh.length).toFixed(3)+' –º' : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

      // –ü—Ä–æ–≥–Ω–æ–∑
      const fc=buildForecast(rows,lv,lvRow.dt);
      document.getElementById('fc65').textContent=lv>=0.65?'‚úÖ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç':fc.high;
      document.getElementById('fc50').textContent=lv<=0.50?'‚úÖ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç':fc.low;
    }

    // –ë–∞—Ç–∞—Ä–µ—è
    const bat=last.bat;
    const BAT_MIN=3.1, BAT_MAX=4.1;
    const pctB=Math.max(0,Math.min(1,(bat-BAT_MIN)/(BAT_MAX-BAT_MIN)));
    const batColor=pctB>0.6?'#22c55e':pctB>0.3?'#f59e0b':'#ef4444';
    drawBat(document.getElementById('batGauge'),pctB,batColor);
    document.getElementById('batNum').textContent=bat.toFixed(2)+' –í';
    document.getElementById('batSub').textContent=Math.round(pctB*100)+'% –∑–∞—Ä—è–¥–∞';

    // ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const dark=document.body.classList.contains('dark');
    const gc=dark?'rgba(255,255,255,.05)':'rgba(0,0,0,.05)';
    const tc=dark?'#94a3b8':'#64748b';

    // 24—á —É—Ä–æ–≤–µ–Ω—å
    const ms24=now-24*3600000;
    const r24=rows.filter(r=>r.dt>ms24&&validDist(r.dist));
    const lbl24=r24.map(r=>`${String(r.dt.getHours()).padStart(2,'0')}:${String(r.dt.getMinutes()).padStart(2,'0')}`);

    if(charts.c24) charts.c24.destroy();
    charts.c24=mkChart('c24',lbl24,[{
      label:'–£—Ä–æ–≤–µ–Ω—å (–º)', data:r24.map(r=>r.dist),
      borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.1)',
      fill:true, tension:.3, pointRadius:2, pointHoverRadius:5
    }]);

    // 7–¥ —Å—Ä–µ–¥–Ω–∏–π
    const ms7=now-7*86400000;
    const byDay={};
    rows.filter(r=>r.dt>ms7&&validDist(r.dist)).forEach(r=>{
      const k=`${String(r.dt.getDate()).padStart(2,'0')}.${String(r.dt.getMonth()+1).padStart(2,'0')}`;
      if(!byDay[k]) byDay[k]=[];
      byDay[k].push(r.dist);
    });
    const lbl7=Object.keys(byDay);
    const dat7=lbl7.map(k=>+(byDay[k].reduce((s,x)=>s+x,0)/byDay[k].length).toFixed(4));

    if(charts.c7d) charts.c7d.destroy();
    charts.c7d=mkChart('c7d',lbl7,[{
      label:'–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (–º)', data:dat7,
      borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.1)',
      fill:true, tension:.3, pointRadius:5, pointHoverRadius:7
    }]);

    // –¢–µ–º–ø + –≤–ª–∞–∂–Ω–æ—Å—Ç—å 24—á
    const rTH=rows.filter(r=>r.dt>ms24);
    const lblTH=rTH.map(r=>`${String(r.dt.getHours()).padStart(2,'0')}:${String(r.dt.getMinutes()).padStart(2,'0')}`);

    if(charts.cTH) charts.cTH.destroy();
    charts.cTH=mkChart('cTH',lblTH,[
      {label:'–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',data:rTH.map(r=>r.temp),borderColor:'#f97316',backgroundColor:'rgba(249,115,22,.08)',fill:false,tension:.3,pointRadius:2,yAxisID:'yT'},
      {label:'–í–ª–∞–∂–Ω–æ—Å—Ç—å (%)',data:rTH.map(r=>r.hum),borderColor:'#06b6d4',backgroundColor:'rgba(6,182,212,.08)',fill:false,tension:.3,pointRadius:2,yAxisID:'yH'}
    ],{
      scales:{
        x:{ticks:{color:tc,maxTicksLimit:8,maxRotation:0},grid:{color:gc}},
        yT:{type:'linear',position:'left',ticks:{color:'#f97316'},grid:{color:gc}},
        yH:{type:'linear',position:'right',ticks:{color:'#06b6d4'},grid:{drawOnChartArea:false}}
      }
    });

  } catch(e){
    showError(e.message);
    console.error(e);
  }
}

loadData();
setInterval(loadData, 5*60*1000);
</script>
</body>
</html>
