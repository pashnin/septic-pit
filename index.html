
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ¡Ğ»Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞ¼Ğ°</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg:#f0f4f8; --surface:#fff; --surface2:#f8fafc;
  --border:#e2e8f0; --text:#1e293b; --text2:#64748b;
  --accent:#3b82f6; --shadow:0 2px 12px rgba(0,0,0,.08);
}
body.dark {
  --bg:#0f172a; --surface:#1e293b; --surface2:#273449;
  --border:#334155; --text:#f1f5f9; --text2:#94a3b8;
  --shadow:0 2px 16px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;transition:background .3s,color .3s;min-height:100vh}

header{background:var(--surface);border-bottom:1px solid var(--border);padding:13px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.h-left{display:flex;align-items:center;gap:9px;font-size:17px;font-weight:700}
.h-right{display:flex;align-items:center;gap:8px}
#dataAge{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);padding:4px 10px;border-radius:20px}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 13px;border-radius:20px;cursor:pointer;font-size:13px;transition:.2s}
.btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

main{max-width:920px;margin:0 auto;padding:18px 14px 40px}
.sec{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin:22px 0 10px}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:13px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:13px}

.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);transition:background .3s}
.lbl{font-size:11px;color:var(--text2);font-weight:500;margin-bottom:7px}
.val{font-size:26px;font-weight:800;line-height:1}
.sub{font-size:12px;color:var(--text2);margin-top:5px}

.level-card{grid-column:span 2;display:flex;align-items:center;gap:20px;padding:20px 22px}
.lv-wrap{position:relative;width:110px;height:110px;flex-shrink:0}
.lv-wrap canvas{position:absolute;top:0;left:0}
.lv-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.lv-num{font-size:21px;font-weight:800;line-height:1}
.lv-unit{font-size:10px;color:var(--text2);margin-top:2px}
.lv-info{flex:1}
.lv-info h2{font-size:15px;font-weight:700;margin-bottom:7px}
.badge{display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:600;padding:4px 12px;border-radius:20px;margin-bottom:9px}
.sg{background:#dcfce7;color:#15803d}
.sy{background:#fef9c3;color:#a16207}
.sr{background:#fee2e2;color:#b91c1c}
body.dark .sg{background:#14532d;color:#86efac}
body.dark .sy{background:#451a03;color:#fcd34d}
body.dark .sr{background:#450a0a;color:#fca5a5}
.avg-row{font-size:12px;color:var(--text2)}
.avg-row b{color:var(--text)}

.bat-card{text-align:center}
.bat-wrap{position:relative;width:92px;height:56px;margin:6px auto 2px}
.bat-num{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:13px;font-weight:700;white-space:nowrap}

.fc-card{border-left:3px solid var(--accent)}
.fc-to{font-size:10px;color:var(--text2);margin-bottom:3px}
.fc-val{font-size:13px;font-weight:700;line-height:1.4}
.fc-note{font-size:11px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin-top:11px;line-height:1.6}

.chart-card{padding:18px}
.chart-wrap{position:relative;height:195px}

#errBox{display:none;background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;border-radius:12px;padding:14px 18px;margin:20px 14px;font-size:14px;line-height:1.6}
#loader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:14px}
.spin{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader p{color:var(--text2);font-size:14px}

@media(max-width:640px){
  .g4{grid-template-columns:1fr 1fr}
  .g2{grid-template-columns:1fr}
  .level-card{grid-column:span 1;flex-direction:column;text-align:center}
  .lv-info h2{display:none}
  .chart-wrap{height:155px}
  .val{font-size:22px}
}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…â€¦</p></div>
<div id="errBox"></div>

<header>
  <div class="h-left">ğŸ  Ğ¡Ğ»Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞ¼Ğ°</div>
  <div class="h-right">
    <span id="dataAge">â€”</span>
    <button class="btn" onclick="toggleTheme()">ğŸŒ™ Ğ¢ĞµĞ¼Ğ°</button>
  </div>
</header>

<main id="app" style="display:none">
  <div class="sec">ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ</div>
  <div class="g2">
    <div class="card level-card">
      <div class="lv-wrap">
        <canvas id="lvGauge" width="110" height="110"></canvas>
        <div class="lv-center">
          <div class="lv-num" id="lvNum">â€”</div>
          <div class="lv-unit">Ğ¼ĞµÑ‚Ñ€Ñ‹</div>
        </div>
      </div>
      <div class="lv-info">
        <h2>Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹</h2>
        <div class="badge" id="lvBadge">â€”</div>
        <div class="avg-row">Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ² ÑÑ‚Ğ¾Ñ‚ Ñ‡Ğ°Ñ (7Ğ´): <b id="avgHour">â€”</b></div>
      </div>
    </div>
    <div class="card bat-card">
      <div class="lbl">ğŸ”‹ Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ</div>
      <div class="bat-wrap">
        <canvas id="batGauge" width="92" height="56"></canvas>
        <div class="bat-num" id="batNum">â€”</div>
      </div>
      <div class="sub" id="batSub">â€”</div>
    </div>
  </div>

  <div class="g4" style="margin-top:13px">
    <div class="card">
      <div class="lbl">ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°</div>
      <div class="val" id="tempVal">â€”</div>
      <div class="sub">Â°C Ğ² ÑĞ¼Ğµ</div>
    </div>
    <div class="card">
      <div class="lbl">ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</div>
      <div class="val" id="humVal">â€”</div>
      <div class="sub">% RH</div>
    </div>
    <div class="card fc-card">
      <div class="lbl">ğŸ“ˆ ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· â†’ 0.65 Ğ¼</div>
      <div class="fc-to">Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ĞµÑ‚ Â«Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹Â»</div>
      <div class="fc-val" id="fc65">â€”</div>
    </div>
    <div class="card fc-card">
      <div class="lbl">ğŸ“‰ ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· â†’ 0.50 Ğ¼</div>
      <div class="fc-to">Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ĞµÑ‚ Â«Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹Â»</div>
      <div class="fc-val" id="fc50">â€”</div>
    </div>
  </div>

  <div class="fc-note">
    <b>ĞœĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ°:</b> Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¸Ğ· 24 Ñ‡Ğ°ÑĞ¾Ğ² ÑÑƒÑ‚Ğ¾Ğº Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ (Ğ¼/Ñ‡Ğ°Ñ) Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹.
    Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑˆĞ°Ğ³Ğ°ĞµÑ‚ÑÑ Ğ²Ğ¿ĞµÑ€Ñ‘Ğ´ Ğ¿Ğ¾ ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ´Ğ¾ Ğ¿ĞµÑ€ĞµÑĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ°.
  </div>

  <div class="sec">ğŸ“‰ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹ â€” 24 Ñ‡Ğ°ÑĞ°</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="c24"></canvas></div></div>

  <div class="sec">ğŸ“† Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ â€” 7 Ğ´Ğ½ĞµĞ¹</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="c7d"></canvas></div></div>

  <div class="sec">ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¸ Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ â€” 24 Ñ‡Ğ°ÑĞ°</div>
  <div class="card chart-card"><div class="chart-wrap"><canvas id="cTH"></canvas></div></div>
</main>

<script>
// â”€â”€ Ğ¢Ğ•ĞœĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const d = document.body.classList.toggle('dark');
  localStorage.setItem('theme', d ? 'dark' : 'light');
  document.querySelector('.btn').textContent = d ? 'â˜€ï¸ Ğ¢ĞµĞ¼Ğ°' : 'ğŸŒ™ Ğ¢ĞµĞ¼Ğ°';
}
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  document.querySelector('.btn').textContent = 'â˜€ï¸ Ğ¢ĞµĞ¼Ğ°';
}

// â”€â”€ ĞŸĞĞ Ğ¡Ğ˜ĞĞ“ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: date,time,dist,temp,hum,bat
// Ğ§Ğ¸ÑĞ»Ğ° Ñ Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑÑ‚Ğ¾Ğ¹ Ğ¾Ğ±Ñ‘Ñ€Ğ½ÑƒÑ‚Ñ‹ Ğ² ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸: "0,676"
// Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ RFC-4180 CSV â€” Ñ€Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‡ĞµÑÑ‚Ğ½Ğ¾

function parseCSVLine(line) {
  // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ°Ñ€ÑĞµÑ€: ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»Ñ Ğ² ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ°Ñ…
  const fields = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') {
      inQ = !inQ;
    } else if (c === ',' && !inQ) {
      fields.push(cur.trim());
      cur = '';
    } else {
      cur += c;
    }
  }
  fields.push(cur.trim());
  return fields;
}

function toNum(s) {
  // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ¸, Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´Ñ€Ğ¾Ğ±Ğ½ÑƒÑ Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºÑƒ
  return parseFloat(s.replace(/"/g, '').replace(',', '.'));
}

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n')
                    .split('\n')
                    .map(l => l.trim())
                    .filter(Boolean);

  if (lines.length < 2) return [];

  // ĞŸĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° â€” Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const p = parseCSVLine(lines[i]);
    if (p.length < 6) continue;

    // p[0]=date DD.MM.YY  p[1]=time H:MM  p[2]=dist  p[3]=temp  p[4]=hum  p[5]=bat
    const dp = p[0].split('.');
    if (dp.length < 3) continue;
    const dd = parseInt(dp[0], 10);
    const mm = parseInt(dp[1], 10) - 1;
    const yy = parseInt(dp[2], 10);
    const yr = yy < 100 ? 2000 + yy : yy;

    const tp = p[1].split(':');
    const hh = parseInt(tp[0], 10);
    const mi = parseInt(tp[1] || '0', 10);

    const dt   = new Date(yr, mm, dd, hh, mi, 0);
    if (isNaN(dt.getTime())) continue;

    const dist = toNum(p[2]);
    const temp = toNum(p[3]);
    const hum  = toNum(p[4]);
    const bat  = toNum(p[5]);

    if ([dist, temp, hum, bat].some(isNaN)) continue;

    rows.push({ dt, dist, temp, hum, bat });
  }

  rows.sort((a, b) => a.dt - b.dt);
  return rows;
}

// Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ°Ñ‚Ñ‡Ğ¸ĞºĞ°
function okDist(d) { return d >= 0.35 && d <= 1.5; }

// â”€â”€ CANVAS GAUGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCircle(canvasId, pct, color) {
  const dark = document.body.classList.contains('dark');
  const bg   = dark ? '#334155' : '#e2e8f0';
  const cv   = document.getElementById(canvasId);
  const ctx  = cv.getContext('2d');
  ctx.clearRect(0, 0, cv.width, cv.height);
  const cx = cv.width / 2, cy = cv.height / 2;
  const r  = Math.min(cx, cy) - 8;
  ctx.lineWidth = 10; ctx.lineCap = 'round';
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.strokeStyle = bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + pct * Math.PI * 2);
  ctx.strokeStyle = color; ctx.stroke();
}

function drawBat(pct, color) {
  const dark = document.body.classList.contains('dark');
  const bg   = dark ? '#334155' : '#e2e8f0';
  const cv   = document.getElementById('batGauge');
  const ctx  = cv.getContext('2d');
  ctx.clearRect(0, 0, cv.width, cv.height);
  const cx = cv.width / 2, cy = cv.height - 4;
  const r  = cx - 6;
  ctx.lineWidth = 9; ctx.lineCap = 'round';
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, 0);
  ctx.strokeStyle = bg; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, Math.PI + pct * Math.PI);
  ctx.strokeStyle = color; ctx.stroke();
}

// â”€â”€ Ğ“Ğ ĞĞ¤Ğ˜ĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const charts = {};
function mkChart(id, labels, datasets, customScales) {
  const dark = document.body.classList.contains('dark');
  const gc   = dark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.05)';
  const tc   = dark ? '#94a3b8' : '#64748b';
  const defaultScales = {
    x: { ticks: { color: tc, maxTicksLimit: 8, maxRotation: 0 }, grid: { color: gc } },
    y: { ticks: { color: tc }, grid: { color: gc } }
  };
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(document.getElementById(id), {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: datasets.length > 1,
          labels: { color: tc, font: { size: 11 }, boxWidth: 10 }
        }
      },
      scales: customScales || defaultScales
    }
  });
}

// â”€â”€ ĞŸĞ ĞĞ“ĞĞĞ—: ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Î” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildForecast(rows, curLevel, curDt) {
  const valid  = rows.filter(r => okDist(r.dist));
  const deltas = Array.from({ length: 24 }, () => []);

  for (let i = 1; i < valid.length; i++) {
    const a = valid[i - 1], b = valid[i];
    const ms = b.dt - a.dt;
    if (ms <= 0 || ms > 2 * 3600000) continue;
    deltas[b.dt.getHours()].push((b.dist - a.dist) / (ms / 3600000));
  }

  const avg = deltas.map(arr =>
    arr.length ? arr.reduce((s, x) => s + x, 0) / arr.length : 0
  );

  function reach(target) {
    let lv = curLevel, dt = new Date(curDt);
    for (let h = 0; h < 7 * 24; h++) {
      lv += avg[dt.getHours()];
      dt  = new Date(dt.getTime() + 3600000);
      if (target > curLevel ? lv >= target : lv <= target)
        return dt.toLocaleString('ru-RU', {
          day: '2-digit', month: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });
    }
    return 'Ğ½Ğµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ (7Ğ´)';
  }

  return { high: reach(0.65), low: reach(0.50) };
}

// â”€â”€ Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtAge(ms) {
  const m = Math.round(ms / 60000);
  return m < 60 ? `Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ${m} Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´` : `Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ${Math.round(m / 60)} Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´`;
}

function fmtTime(dt) {
  return String(dt.getHours()).padStart(2, '0') + ':' + String(dt.getMinutes()).padStart(2, '0');
}

function showError(msg) {
  document.getElementById('loader').style.display = 'none';
  const b = document.getElementById('errBox');
  b.style.display = 'block';
  b.innerHTML = 'âš ï¸ ' + msg;
}

// â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const res = await fetch('./data.csv?t=' + Date.now());
    if (!res.ok) throw new Error(`Ğ¤Ğ°Ğ¹Ğ» data.csv Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ (HTTP ${res.status})`);

    const text = await res.text();
    if (!text.trim()) throw new Error('Ğ¤Ğ°Ğ¹Ğ» data.csv Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹');

    const rows = parseCSV(text);
    if (!rows.length) throw new Error(
      'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ data.csv.<br>' +
      'ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚:<br>' +
      '<code>date,time,dist,temp,hum,bat</code><br>' +
      '<code>07.02.26,14:59,"0,676","0,8",13,"4,1"</code>'
    );

    document.getElementById('loader').style.display = 'none';
    document.getElementById('app').style.display    = 'block';

    const now  = new Date();
    const last = rows[rows.length - 1];

    // Ğ’Ğ¾Ğ·Ñ€Ğ°ÑÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    document.getElementById('dataAge').textContent = fmtAge(now - last.dt);

    // Ğ¢ĞµĞ¼Ğ¿ / Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ
    document.getElementById('tempVal').textContent = last.temp.toFixed(1) + ' Â°C';
    document.getElementById('humVal').textContent  = last.hum.toFixed(1)  + ' %';

    // ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ
    let lv = null, lvRow = null;
    for (let i = rows.length - 1; i >= 0; i--) {
      if (okDist(rows[i].dist)) { lv = rows[i].dist; lvRow = rows[i]; break; }
    }

    if (lv !== null) {
      document.getElementById('lvNum').textContent = lv.toFixed(3);

      let color, cls, label;
      if      (lv > 0.65) { color = '#22c55e'; cls = 'sg'; label = 'ğŸŸ¢ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹'; }
      else if (lv >= 0.50) { color = '#f59e0b'; cls = 'sy'; label = 'ğŸŸ¡ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹'; }
      else                 { color = '#ef4444'; cls = 'sr'; label = 'ğŸ”´ ĞĞ¸Ğ·ĞºĞ¸Ğ¹';  }

      const badge = document.getElementById('lvBadge');
      badge.textContent = label;
      badge.className   = 'badge ' + cls;

      // Gauge ÑƒÑ€Ğ¾Ğ²Ğ½Ñ (Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ 0.40â€“0.80)
      drawCircle('lvGauge', Math.max(0, Math.min(1, (lv - 0.40) / 0.40)), color);

      // Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ² ÑÑ‚Ğ¾Ñ‚ Ñ‡Ğ°Ñ Ğ·Ğ° 7Ğ´
      const ago7  = new Date(now - 7 * 86400000);
      const same  = rows.filter(r => r.dt > ago7 && r.dt.getHours() === now.getHours() && okDist(r.dist));
      document.getElementById('avgHour').textContent =
        same.length
          ? (same.reduce((s, r) => s + r.dist, 0) / same.length).toFixed(3) + ' Ğ¼'
          : 'Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';

      // ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·
      const fc = buildForecast(rows, lv, lvRow.dt);
      document.getElementById('fc65').textContent = lv >= 0.65 ? 'âœ… ÑƒĞ¶Ğµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚' : fc.high;
      document.getElementById('fc50').textContent = lv <= 0.50 ? 'âœ… ÑƒĞ¶Ğµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚' : fc.low;
    }

    // Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ (3.1Ğ’ = 0%, 4.1Ğ’ = 100%)
    const bat  = last.bat;
    const pctB = Math.max(0, Math.min(1, (bat - 3.1) / 1.0));
    const batC = pctB > 0.6 ? '#22c55e' : pctB > 0.3 ? '#f59e0b' : '#ef4444';
    drawBat(pctB, batC);
    document.getElementById('batNum').textContent = bat.toFixed(2) + ' Ğ’';
    document.getElementById('batSub').textContent = Math.round(pctB * 100) + '% Ğ·Ğ°Ñ€ÑĞ´Ğ°';

    // â”€â”€ Ğ“Ñ€Ğ°Ñ„Ğ¸ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dark = document.body.classList.contains('dark');
    const gc   = dark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.05)';
    const tc   = dark ? '#94a3b8' : '#64748b';

    // 24Ñ‡ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ
    const ms24 = now - 24 * 3600000;
    const r24  = rows.filter(r => r.dt > ms24 && okDist(r.dist));
    mkChart('c24', r24.map(r => fmtTime(r.dt)), [{
      label: 'Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ (Ğ¼)', data: r24.map(r => r.dist),
      borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,.1)',
      fill: true, tension: .3, pointRadius: 2, pointHoverRadius: 5
    }]);

    // 7Ğ´ ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ·Ğ° ÑÑƒÑ‚ĞºĞ¸
    const ms7   = now - 7 * 86400000;
    const byDay = {};
    rows.filter(r => r.dt > ms7 && okDist(r.dist)).forEach(r => {
      const k = String(r.dt.getDate()).padStart(2, '0') + '.'
              + String(r.dt.getMonth() + 1).padStart(2, '0');
      (byDay[k] = byDay[k] || []).push(r.dist);
    });
    const lbl7 = Object.keys(byDay);
    const dat7 = lbl7.map(k =>
      +(byDay[k].reduce((s, x) => s + x, 0) / byDay[k].length).toFixed(4)
    );
    mkChart('c7d', lbl7, [{
      label: 'Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ (Ğ¼)', data: dat7,
      borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,.1)',
      fill: true, tension: .3, pointRadius: 5, pointHoverRadius: 7
    }]);

    // Ğ¢ĞµĞ¼Ğ¿ + Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ 24Ñ‡ (Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ°Ñ Ğ¾ÑÑŒ Y)
    const rTH   = rows.filter(r => r.dt > ms24);
    mkChart('cTH', rTH.map(r => fmtTime(r.dt)), [
      {
        label: 'Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° (Â°C)', data: rTH.map(r => r.temp),
        borderColor: '#f97316', fill: false, tension: .3,
        pointRadius: 2, yAxisID: 'yT'
      },
      {
        label: 'Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ (%)', data: rTH.map(r => r.hum),
        borderColor: '#06b6d4', fill: false, tension: .3,
        pointRadius: 2, yAxisID: 'yH'
      }
    ], {
      x:  { ticks: { color: tc, maxTicksLimit: 8, maxRotation: 0 }, grid: { color: gc } },
      yT: { type: 'linear', position: 'left',  ticks: { color: '#f97316' }, grid: { color: gc } },
      yH: { type: 'linear', position: 'right', ticks: { color: '#06b6d4' }, grid: { drawOnChartArea: false } }
    });

  } catch (e) {
    showError(e.message);
    console.error(e);
  }
}

loadData();
setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
