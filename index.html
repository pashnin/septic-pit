
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ĞŸÑ€Ğ¾ĞµĞºÑ‚ Â«Ğ’ĞµĞ½ĞµÑ€Ğ°Â»</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#f0f4f8;--surface:#fff;--surface2:#f8fafc;
  --border:#e2e8f0;--text:#1e293b;--text2:#64748b;
  --accent:#3b82f6;--shadow:0 2px 12px rgba(0,0,0,.08);
}
body.dark{
  --bg:#0f172a;--surface:#1e293b;--surface2:#273449;
  --border:#334155;--text:#f1f5f9;--text2:#94a3b8;
  --shadow:0 2px 16px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;transition:background .3s,color .3s;min-height:100vh}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:13px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.h-left{font-size:17px;font-weight:700}
.h-right{display:flex;align-items:center;gap:8px}
#dataAge{font-size:12px;color:var(--text2);background:var(--surface2);border:1px solid var(--border);padding:4px 10px;border-radius:20px;transition:.3s}
#dataAge.stale{background:#fee2e2;color:#b91c1c;border-color:#fca5a5}
body.dark #dataAge.stale{background:#450a0a;color:#fca5a5;border-color:#7f1d1d}
#gapWarn{display:none;font-size:12px;font-weight:600;background:#fef9c3;color:#a16207;border:1px solid #fde68a;padding:4px 10px;border-radius:20px}
body.dark #gapWarn{background:#451a03;color:#fcd34d;border-color:#78350f}
#gapWarn.show{display:block}
.btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 13px;border-radius:20px;cursor:pointer;font-size:13px;transition:.2s}
.btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
main{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
.sec{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin:22px 0 10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.sec-time{font-size:12px;font-weight:700;color:var(--text);background:var(--surface);border:1px solid var(--border);padding:2px 10px;border-radius:20px;text-transform:none;letter-spacing:0}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow);transition:background .3s}
.lbl{font-size:11px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.val{font-size:30px;font-weight:800;line-height:1}
.sub{font-size:12px;color:var(--text2);margin-top:5px}
.thermo-wrap{display:flex;align-items:center;justify-content:center;gap:10px;margin:6px auto 8px}
.thermo-ticks{display:flex;flex-direction:column;justify-content:space-between;height:160px;padding:6px 0}
.thermo-ticks span{font-size:10px;color:var(--text2);line-height:1;white-space:nowrap}
.badge{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600;padding:3px 10px;border-radius:20px;margin:6px 0 4px}
.sg{background:#dcfce7;color:#15803d} body.dark .sg{background:#14532d;color:#86efac}
.sy{background:#fef9c3;color:#a16207} body.dark .sy{background:#451a03;color:#fcd34d}
.sr{background:#fee2e2;color:#b91c1c} body.dark .sr{background:#450a0a;color:#fca5a5}
.fc-mini{font-size:11px;color:var(--text2);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;margin-top:6px}
.fc-mini b{color:var(--text)}
.avg-mini{font-size:11px;color:var(--text2);margin-bottom:4px}
.avg-mini b{color:var(--text)}
.bat-wrap{position:relative;width:90px;height:55px;margin:8px auto 4px}
.bat-num{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:13px;font-weight:700;white-space:nowrap}
.hum-alert{display:none;background:#fee2e2;color:#b91c1c;border-radius:10px;padding:6px 10px;font-size:12px;font-weight:600;margin-top:8px;text-align:center;line-height:1.4}
body.dark .hum-alert{background:#450a0a;color:#fca5a5}
.hum-alert.show{display:block}
.chart-card{padding:18px;position:relative}
.gap-badge{display:none;position:absolute;top:12px;right:14px;font-size:10px;font-weight:600;background:#fef9c3;color:#a16207;border:1px solid #fde68a;padding:2px 8px;border-radius:20px;z-index:2}
body.dark .gap-badge{background:#451a03;color:#fcd34d;border-color:#78350f}
.gap-badge.show{display:block}
.chart-wrap{position:relative;height:210px}
.chart-title{font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text)}
#errBox{display:none;background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5;border-radius:12px;padding:14px 18px;margin:20px 0;font-size:14px;line-height:1.6}
#loader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:14px}
.spin{width:38px;height:38px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader p{color:var(--text2);font-size:14px}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}
@media(max-width:560px){.g2{grid-template-columns:1fr}.chart-wrap{height:160px}}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…â€¦</p></div>
<div id="errBox"></div>

<header>
  <div class="h-left">ğŸ  Ğ¡Ğ»Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞ¼Ğ°</div>
  <div class="h-right">
    <span id="gapWarn">âš ï¸ ĞµÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¸</span>
    <span id="dataAge">â€”</span>
    <button class="btn" onclick="toggleTheme()">ğŸŒ™ Ğ¢ĞµĞ¼Ğ°</button>
  </div>
</header>

<main id="app" style="display:none">

  <div class="sec">ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ <span class="sec-time" id="secTime">â€”</span></div>
  <div class="g4">
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸ“ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹</div>
      <div class="thermo-wrap">
        <canvas id="thermoCanvas" width="36" height="172"></canvas>
        <div class="thermo-ticks">
          <span>0</span><span>âˆ’0.2</span><span>âˆ’0.4</span>
          <span>âˆ’0.6</span><span>âˆ’0.8</span><span>âˆ’0.95</span>
        </div>
      </div>
      <div class="badge" id="lvBadge">â€”</div>
      <div style="font-size:22px;font-weight:800;line-height:1;margin-bottom:4px" id="lvNum">â€”</div>
      <div style="font-size:11px;color:var(--text2)">Ğ¼ĞµÑ‚Ñ€Ñ‹</div>
      <div class="avg-mini" style="margin-top:8px">Ğ¡Ñ€. Ñ‡Ğ°Ñ (7Ğ´): <b id="avgHour">â€”</b></div>
      <div class="fc-mini">
        â†‘ Ğ´Ğ¾ âˆ’0.50 Ğ¼: <b id="fc50">â€”</b><br>
        â†“ Ğ´Ğ¾ âˆ’0.65 Ğ¼: <b id="fc65">â€”</b>
      </div>
    </div>
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸ”‹ Ğ‘Ğ°Ñ‚Ğ°Ñ€ĞµÑ</div>
      <div class="bat-wrap">
        <canvas id="batGauge" width="90" height="55"></canvas>
        <div class="bat-num" id="batNum">â€”</div>
      </div>
      <div class="sub" id="batSub">â€”</div>
    </div>
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°</div>
      <div class="val" id="tempVal" style="margin-top:32px">â€”</div>
      <div class="sub">Â°C Ğ² ÑĞ¼Ğµ</div>
    </div>
    <div class="card" style="text-align:center">
      <div class="lbl">ğŸ’§ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</div>
      <div class="val" id="humVal" style="margin-top:32px">â€”</div>
      <div class="sub">% RH</div>
      <div class="hum-alert" id="humAlert">â€”</div>
    </div>
  </div>

  <div class="sec">ğŸ“‰ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹</div>
  <div class="g2">
    <div class="card chart-card">
      <div class="chart-title">24 Ñ‡Ğ°ÑĞ°</div>
      <span class="gap-badge" id="gap24">ã€° Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</span>
      <div class="chart-wrap"><canvas id="c24"></canvas></div>
    </div>
    <div class="card chart-card">
      <div class="chart-title">Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ñ‡Ğ°Ñ â€” 7 Ğ´Ğ½ĞµĞ¹</div>
      <div class="chart-wrap"><canvas id="cByHour"></canvas></div>
    </div>
  </div>

  <div class="sec">ğŸ“† Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ</div>
  <div class="g2">
    <div class="card chart-card">
      <div class="chart-title">Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ â€” 7 Ğ´Ğ½ĞµĞ¹</div>
      <span class="gap-badge" id="gap7avg">ã€° Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</span>
      <div class="chart-wrap"><canvas id="c7avg"></canvas></div>
    </div>
    <div class="card chart-card">
      <div class="chart-title">Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ â€” 30 Ğ´Ğ½ĞµĞ¹</div>
      <div class="chart-wrap"><canvas id="c30avg"></canvas></div>
    </div>
  </div>

  <div class="sec">ğŸŒ¡ï¸ Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¸ Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ â€” 24 Ñ‡Ğ°ÑĞ°</div>
  <div class="g2">
    <div class="card chart-card">
      <div class="chart-title">Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° (Â°C)</div>
      <div class="chart-wrap"><canvas id="cTemp"></canvas></div>
    </div>
    <div class="card chart-card">
      <div class="chart-title">Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ (%)</div>
      <div class="chart-wrap"><canvas id="cHum"></canvas></div>
    </div>
  </div>

</main>

<script>
// â”€â”€ Ğ¢Ğ•ĞœĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme(){
  const d=document.body.classList.toggle('dark');
  localStorage.setItem('theme',d?'dark':'light');
  document.querySelector('.btn').textContent=d?'â˜€ï¸ Ğ¢ĞµĞ¼Ğ°':'ğŸŒ™ Ğ¢ĞµĞ¼Ğ°';
}
if(localStorage.getItem('theme')==='dark'){
  document.body.classList.add('dark');
  document.querySelector('.btn').textContent='â˜€ï¸ Ğ¢ĞµĞ¼Ğ°';
}

// â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseLine(line){
  const f=[];let cur='',inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"')inQ=!inQ;
    else if(c===','&&!inQ){f.push(cur.trim());cur='';}
    else cur+=c;
  }
  f.push(cur.trim());return f;
}
function toNum(s){return parseFloat((s||'').replace(/"/g,'').replace(',','.'));}
function parseCSV(text){
  const lines=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n')
                  .split('\n').map(l=>l.trim()).filter(Boolean);
  if(lines.length<2)return[];
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const p=parseLine(lines[i]);
    if(p.length<6)continue;
    const dp=p[0].split('.');
    if(dp.length<3)continue;
    const yr=parseInt(dp[2],10)<100?2000+parseInt(dp[2],10):parseInt(dp[2],10);
    const tp=p[1].split(':');
    const dt=new Date(yr,parseInt(dp[1],10)-1,parseInt(dp[0],10),parseInt(tp[0],10),parseInt(tp[1]||'0',10));
    if(isNaN(dt.getTime()))continue;
    const dist=toNum(p[2]),temp=toNum(p[3]),hum=toNum(p[4]),bat=toNum(p[5]);
    if([dist,temp,hum,bat].some(isNaN))continue;
    rows.push({dt,dist,temp,hum,bat,synthetic:false});
  }
  rows.sort((a,b)=>a.dt-b.dt);
  return rows;
}

function okDist(d){return d<-0.2&&d>-1.5&&Math.abs(d+1.0)>0.01;}

function gapFill(rows,maxGapHours=48){
  const STEP=3600000,maxMs=maxGapHours*STEP;
  const out=[];let hadGap=false;
  for(let i=0;i<rows.length;i++){
    const cur=rows[i];
    if(i>0){
      const prev=rows[i-1],diff=cur.dt-prev.dt;
      if(diff>90*60*1000&&diff<=maxMs){
        hadGap=true;
        let fd=okDist(prev.dist)?prev.dist:null;
        if(fd===null)for(let j=out.length-1;j>=0;j--){if(okDist(out[j].dist)){fd=out[j].dist;break;}}
        if(fd!==null){
          let t=new Date(prev.dt.getTime()+STEP);
          while(t<cur.dt-30*60*1000){
            out.push({dt:new Date(t),dist:fd,temp:prev.temp,hum:prev.hum,bat:prev.bat,synthetic:true});
            t=new Date(t.getTime()+STEP);
          }
        }
      }else if(diff>maxMs)hadGap=true;
    }
    out.push(cur);
  }
  return{rows:out,hadGap};
}

function levelStatus(d){
  if(d>-0.5) return{color:'#ef4444',cls:'sr',label:'ğŸ”´ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹'};
  if(d>=-0.65)return{color:'#f59e0b',cls:'sy',label:'ğŸŸ¡ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹'};
  return           {color:'#22c55e',cls:'sg',label:'ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹'};
}

// Ğ¦Ğ²ĞµÑ‚ ÑÑ‚Ğ¾Ğ»Ğ±Ğ° Ğ¿Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
function zoneColor(v){
  if(v===null||v===undefined)return'transparent';
  if(v>-0.5) return'rgba(239,68,68,.85)';
  if(v>=-0.65)return'rgba(245,158,11,.85)';
  return          'rgba(34,197,94,.85)';
}

// â”€â”€ Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ min Ğ¾ÑĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞµ Ğ²Ñ‹ÑˆĞµ -1.0, Ğ½Ğ¾ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ¸Ğ¶Ğµ â€” Ñ€Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼ + Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿ 0.05
function dynMin(values){
  const validVals=values.filter(v=>v!==null&&v!==undefined);
  const dataMin=validVals.length?Math.min(...validVals):0;
  return Math.min(-1.0, dataMin - 0.05);
}

// â”€â”€ Ğ¢Ğ•Ğ ĞœĞĞœĞ•Ğ¢Ğ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawThermo(value){
  const cv=document.getElementById('thermoCanvas');
  const ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height;
  ctx.clearRect(0,0,W,H);
  const dark=document.body.classList.contains('dark');
  const trackBg=dark?'#334155':'#e2e8f0';
  const borderC=dark?'#475569':'#cbd5e1';
  const R=10,tw=22,tx=(W-tw)/2,ty=6,th=H-12;
  const MIN=-0.95,MAX=0;
  function valToY(v){return ty+th-((v-MIN)/(MAX-MIN))*th;}
  ctx.beginPath();ctx.roundRect(tx,ty,tw,th,R);ctx.fillStyle=trackBg;ctx.fill();
  function fillZone(yTop,yBot,color){
    const cTop=Math.max(yTop,ty),cBot=Math.min(yBot,ty+th);
    if(cBot<=cTop)return;
    ctx.save();ctx.beginPath();ctx.roundRect(tx,ty,tw,th,R);ctx.clip();
    ctx.fillStyle=color;ctx.fillRect(tx,cTop,tw,cBot-cTop);ctx.restore();
  }
  fillZone(valToY(-0.65),valToY(-0.95),'#22c55e');
  fillZone(valToY(-0.50),valToY(-0.65),'#f59e0b');
  fillZone(valToY(0),    valToY(-0.50),'#ef4444');
  if(value!==null&&okDist(value)){
    const yVal=valToY(Math.max(MIN,Math.min(MAX,value)));
    ctx.save();ctx.beginPath();ctx.roundRect(tx,ty,tw,th,R);ctx.clip();
    ctx.fillStyle=trackBg;ctx.fillRect(tx,ty,tw,yVal-ty);ctx.restore();
    const ax=tx+tw+3,ay=yVal,ac=levelStatus(value).color;
    ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(ax+7,ay-5);ctx.lineTo(ax+7,ay+5);
    ctx.closePath();ctx.fillStyle=ac;ctx.fill();
  }
  ctx.beginPath();ctx.roundRect(tx,ty,tw,th,R);ctx.strokeStyle=borderC;ctx.lineWidth=1.5;ctx.stroke();
  [-0.50,-0.65].forEach(v=>{
    const y=valToY(v);
    ctx.beginPath();ctx.moveTo(tx,y);ctx.lineTo(tx+tw,y);
    ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=1;ctx.stroke();
  });
}

// â”€â”€ Ğ‘ĞĞ¢ĞĞ Ğ•Ğ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBat(pct,color){
  const dark=document.body.classList.contains('dark');
  const cv=document.getElementById('batGauge'),ctx=cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  const cx=cv.width/2,cy=cv.height-4,r=cx-6;
  ctx.lineWidth=9;ctx.lineCap='round';
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);
  ctx.strokeStyle=dark?'#334155':'#e2e8f0';ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,Math.PI+pct*Math.PI);
  ctx.strokeStyle=color;ctx.stroke();
}

// â”€â”€ Ğ“Ğ ĞĞ¤Ğ˜ĞšĞ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CH={};
function gc(){return document.body.classList.contains('dark')?'rgba(255,255,255,.05)':'rgba(0,0,0,.05)';}
function tc(){return document.body.classList.contains('dark')?'#94a3b8':'#64748b';}
function xSc(){return{ticks:{color:tc(),maxTicksLimit:8,maxRotation:0},grid:{color:gc()}};}

// ĞÑÑŒ Y Ğ´Ğ»Ñ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ â€” Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ min, max Ğ²ÑĞµĞ³Ğ´Ğ° 0
function yLvSc(minVal){
  return{
    min:minVal, max:0,
    ticks:{color:tc(),callback:v=>v.toFixed(2)},
    grid:{color:gc()}
  };
}
function yNormSc(){return{ticks:{color:tc()},grid:{color:gc()}};}

// Ğ›Ğ¸Ğ½Ğ¸Ğ¸ Ğ·Ğ¾Ğ½ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ğ±Ğ°Ñ€Ğ° â€” Ğ°Ğ½Ğ½Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Chart.js annotation plugin Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼,
// Ğ²Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ dataset-Ñ‹ Ñ‚Ğ¸Ğ¿Ğ° line Ğ´Ğ»Ñ Ğ¿ÑƒĞ½ĞºÑ‚Ğ¸Ñ€Ğ½Ñ‹Ñ… Ğ»Ğ¸Ğ½Ğ¸Ğ¹
function zoneLines(minVal){
  return[
    {
      type:'line',
      label:'âˆ’0.50',
      data:Array(100).fill(-0.50),
      borderColor:'rgba(239,68,68,.5)',
      borderWidth:1,borderDash:[4,4],
      pointRadius:0,fill:false,order:0
    },
    {
      type:'line',
      label:'âˆ’0.65',
      data:Array(100).fill(-0.65),
      borderColor:'rgba(34,197,94,.5)',
      borderWidth:1,borderDash:[4,4],
      pointRadius:0,fill:false,order:0
    }
  ];
}

// â”€â”€ Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ñ€-Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº ÑƒÑ€Ğ¾Ğ²Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// values: Ğ¼Ğ°ÑÑĞ¸Ğ² Ñ‡Ğ¸ÑĞµĞ» Ğ¸Ğ»Ğ¸ null
// labels: Ğ¼Ğ°ÑÑĞ¸Ğ² ÑÑ‚Ñ€Ğ¾Ğº
// synthFlags: Ğ¼Ğ°ÑÑĞ¸Ğ² bool (Ğ´Ğ»Ñ gap-fill) â€” Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹
function mkBarLevel(id,labels,values,synthFlags){
  if(CH[id])CH[id].destroy();

  const minVal=dynMin(values);
  const colors=values.map((v,i)=>{
    if(v===null)return'transparent';
    // ÑĞ¸Ğ½Ñ‚ĞµÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â€” Ğ¿Ğ¾Ğ»ÑƒĞ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğµ Ñ„Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğµ
    if(synthFlags&&synthFlags[i])return'rgba(168,85,247,.5)';
    return zoneColor(v);
  });

  // ĞŸÑƒĞ½ĞºÑ‚Ğ¸Ñ€Ğ½Ñ‹Ğµ Ğ»Ğ¸Ğ½Ğ¸Ğ¸ Ğ·Ğ¾Ğ½ (ĞºĞ°Ğº Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ dataset type:line)
  const lineLen=labels.length;
  const line50=new Array(lineLen).fill(-0.50);
  const line65=new Array(lineLen).fill(-0.65);

  CH[id]=new Chart(document.getElementById(id),{
    type:'bar',
    data:{
      labels,
      datasets:[
        {
          type:'bar',
          data:values,
          backgroundColor:colors,
          borderRadius:2,
          barPercentage:.9,
          categoryPercentage:.85,
          base:minVal,   // ÑÑ‚Ğ¾Ğ»Ğ±Ñ‹ Ñ€Ğ°ÑÑ‚ÑƒÑ‚ Ğ¾Ñ‚ dynMin Ğ²Ğ²ĞµÑ€Ñ…
          order:1
        },
        {
          type:'line',
          data:line50,
          borderColor:'rgba(239,68,68,.6)',
          borderWidth:1.5,
          borderDash:[5,4],
          pointRadius:0,
          fill:false,
          order:0,
          tension:0
        },
        {
          type:'line',
          data:line65,
          borderColor:'rgba(245,158,11,.6)',
          borderWidth:1.5,
          borderDash:[5,4],
          pointRadius:0,
          fill:false,
          order:0,
          tension:0
        }
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          filter:item=>item.datasetIndex===0,  // Ñ‚ÑƒĞ»Ñ‚Ğ¸Ğ¿ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ±Ğ°Ñ€Ğ¾Ğ²
          callbacks:{label:ctx=>{
            const v=ctx.parsed.y;
            if(v===null||v===undefined)return'';
            const syn=synthFlags&&synthFlags[ctx.dataIndex]?' (Ğ´ÑƒĞ±Ğ»ÑŒ)':'';
            return` ${v.toFixed(3)}${syn}`;
          }}
        }
      },
      scales:{
        x:xSc(),
        y:yLvSc(minVal)
      }
    }
  });
}

// Ğ›Ğ¸Ğ½ĞµĞ¹Ğ½Ñ‹Ğ¹ (Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° / Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ)
function mkLine(id,pts,color,fillColor){
  if(CH[id])CH[id].destroy();
  CH[id]=new Chart(document.getElementById(id),{
    type:'line',
    data:{
      labels:pts.map(p=>p.label),
      datasets:[{
        data:pts.map(p=>p.value),
        borderColor:color,backgroundColor:fillColor,
        fill:true,tension:.35,
        pointRadius:pts.length>150?0:pts.length>50?1:3,
        pointHoverRadius:5
      }]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y?.toFixed(1)}`}}},
      scales:{x:xSc(),y:yNormSc()}
    }
  });
}

// â”€â”€ ĞŸĞ ĞĞ“ĞĞĞ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildForecast(rawRows,lv,lvDt){
  const valid=rawRows.filter(r=>okDist(r.dist));
  const deltas=Array.from({length:24},()=>[]);
  for(let i=1;i<valid.length;i++){
    const a=valid[i-1],b=valid[i],ms=b.dt-a.dt;
    if(ms<=0||ms>2*3600000)continue;
    deltas[b.dt.getHours()].push((b.dist-a.dist)/(ms/3600000));
  }
  const avg=deltas.map(arr=>arr.length?arr.reduce((s,x)=>s+x,0)/arr.length:0);
  function reach(target,goUp){
    let v=lv,dt=new Date(lvDt);
    for(let h=0;h<7*24;h++){
      v+=avg[dt.getHours()];dt=new Date(dt.getTime()+3600000);
      if(goUp?v>=target:v<=target)
        return dt.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    return'Ğ½Ğµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ (7Ğ´)';
  }
  return{high:reach(-0.50,true),low:reach(-0.65,false)};
}

function fmtAge(ms){const m=Math.round(ms/60000);return m<60?`Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ${m} Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´`:`Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ${Math.round(m/60)} Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´`;}
function fmtTime(dt){return String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');}
function fmtDay(dt){return String(dt.getDate()).padStart(2,'0')+'.'+String(dt.getMonth()+1).padStart(2,'0');}
function showError(msg){
  document.getElementById('loader').style.display='none';
  const b=document.getElementById('errBox');b.style.display='block';b.innerHTML='âš ï¸ '+msg;
}

// â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(){
  try{
    const res=await fetch('./data.csv?t='+Date.now());
    if(!res.ok)throw new Error(`data.csv Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ (HTTP ${res.status})`);
    const text=await res.text();
    if(!text.trim())throw new Error('data.csv Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹');
    const rawRows=parseCSV(text);
    if(!rawRows.length)throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ data.csv.');

    const{rows,hadGap}=gapFill(rawRows,48);
    document.getElementById('loader').style.display='none';
    document.getElementById('app').style.display='block';

    const now=new Date();
    const lastReal=rawRows[rawRows.length-1];

    const ageMs=now-lastReal.dt;
    const ageEl=document.getElementById('dataAge');
    ageEl.textContent=fmtAge(ageMs);
    ageEl.className=ageMs>2*3600000?'stale':'';
    document.getElementById('gapWarn').classList.toggle('show',hadGap);
    document.getElementById('secTime').textContent=
      lastReal.dt.toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});

    document.getElementById('tempVal').textContent=lastReal.temp.toFixed(1)+' Â°C';
    document.getElementById('humVal').textContent=lastReal.hum.toFixed(1)+' %';

    const humAlert=document.getElementById('humAlert');
    const lastN=rawRows.slice(-10);
    const humRising=lastN.length===10&&lastN.every((r,i)=>i===0||r.hum>=lastN[i-1].hum);
    const humHigh=lastReal.hum>=40;
    if(humRising||humHigh){
      humAlert.classList.add('show');
      humAlert.textContent=humHigh?`âš ï¸ ${lastReal.hum.toFixed(1)}% â€” Ğ²Ñ‹ÑˆĞµ 40%!`:'âš ï¸ Ğ’Ğ»Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ 10 Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´!';
    }else humAlert.classList.remove('show');

    let lv=null,lvRow=null;
    for(let i=rawRows.length-1;i>=0;i--){if(okDist(rawRows[i].dist)){lv=rawRows[i].dist;lvRow=rawRows[i];break;}}
    drawThermo(lv);
    if(lv!==null){
      document.getElementById('lvNum').textContent=lv.toFixed(3);
      const st=levelStatus(lv);
      const badge=document.getElementById('lvBadge');
      badge.textContent=st.label;badge.className='badge '+st.cls;
      const ago7=new Date(now-7*86400000);
      const same=rawRows.filter(r=>r.dt>ago7&&r.dt.getHours()===now.getHours()&&okDist(r.dist));
      document.getElementById('avgHour').textContent=same.length
        ?(same.reduce((s,r)=>s+r.dist,0)/same.length).toFixed(3)+' Ğ¼':'Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
      const fc=buildForecast(rawRows,lv,lvRow.dt);
      document.getElementById('fc50').textContent=lv>=-0.50?'âœ… ÑƒĞ¶Ğµ':fc.high;
      document.getElementById('fc65').textContent=lv<=-0.65?'âœ… ÑƒĞ¶Ğµ':fc.low;
    }else{
      document.getElementById('lvNum').textContent='â€”';
      document.getElementById('lvBadge').textContent='âš ï¸ Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
    }

    const bat=lastReal.bat;
    const pctB=Math.max(0,Math.min(1,(bat-3.1)/1.0));
    const batC=pctB>0.6?'#22c55e':pctB>0.3?'#f59e0b':'#ef4444';
    drawBat(pctB,batC);
    document.getElementById('batNum').textContent=bat.toFixed(2)+' Ğ’';
    document.getElementById('batSub').textContent=Math.round(pctB*100)+'% Ğ·Ğ°Ñ€ÑĞ´Ğ°';

    const ms24=now-24*3600000,ms7=now-7*86400000,ms30=now-30*86400000;

    // â”€â”€ Ğ Ğ¯Ğ” 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // 24 Ñ‡Ğ°ÑĞ° â€” Ğ²ÑĞµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ (Ñ gap-fill)
    const r24=rows.filter(r=>r.dt>ms24&&okDist(r.dist));
    document.getElementById('gap24').classList.toggle('show',r24.some(r=>r.synthetic));
    mkBarLevel(
      'c24',
      r24.map(r=>fmtTime(r.dt)),
      r24.map(r=>r.dist),
      r24.map(r=>r.synthetic)
    );

    // Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ñ‡Ğ°Ñ ÑÑƒÑ‚Ğ¾Ğº â€” 7 Ğ´Ğ½ĞµĞ¹
    const hourLabels=Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+':00');
    const hourVals=Array.from({length:24},(_,h)=>{
      const pts=rawRows.filter(r=>r.dt>ms7&&r.dt.getHours()===h&&okDist(r.dist));
      return pts.length?+(pts.reduce((s,r)=>s+r.dist,0)/pts.length).toFixed(4):null;
    });
    mkBarLevel('cByHour',hourLabels,hourVals,null);

    // â”€â”€ Ğ Ğ¯Ğ” 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function dayAvg(ms){
      const map={};
      rawRows.filter(r=>r.dt>ms&&okDist(r.dist)).forEach(r=>{
        const k=fmtDay(r.dt);(map[k]=map[k]||[]).push(r.dist);
      });
      const labels=Object.keys(map);
      const vals=labels.map(k=>+(map[k].reduce((s,x)=>s+x,0)/map[k].length).toFixed(4));
      return{labels,vals};
    }

    // Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ â€” 7 Ğ´Ğ½ĞµĞ¹
    const d7=dayAvg(ms7);
    document.getElementById('gap7avg').classList.toggle('show',hadGap&&d7.labels.length<7);
    mkBarLevel('c7avg',d7.labels,d7.vals,null);

    // Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ â€” 30 Ğ´Ğ½ĞµĞ¹
    const d30=dayAvg(ms30);
    mkBarLevel('c30avg',d30.labels,d30.vals,null);

    // â”€â”€ Ğ Ğ¯Ğ” 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const rTH=rows.filter(r=>r.dt>ms24);
    mkLine('cTemp',rTH.map(r=>({label:fmtTime(r.dt),value:r.temp})),'#f97316','rgba(249,115,22,.15)');
    mkLine('cHum', rTH.map(r=>({label:fmtTime(r.dt),value:r.hum})), '#06b6d4','rgba(6,182,212,.15)');

  }catch(e){showError(e.message);console.error(e);}
}

loadData();
setInterval(loadData,5*60*1000);
</script>
</body>
</html>
